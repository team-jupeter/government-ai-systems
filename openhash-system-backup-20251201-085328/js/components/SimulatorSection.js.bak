const SimulatorSection = () => {
    const [documentHash, setDocumentHash] = React.useState('');
    const [timestamp, setTimestamp] = React.useState('');
    const [firstHash, setFirstHash] = React.useState('');
    const [secondHash, setSecondHash] = React.useState('');
    const [layerValue, setLayerValue] = React.useState(null);
    const [selectedLayer, setSelectedLayer] = React.useState(null);
    const [isSimulating, setIsSimulating] = React.useState(false);

    const simulateSHA256 = async (input) => {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    };

    const runSimulation = async () => {
        setIsSimulating(true);
        const docHash = await simulateSHA256('Sample Document ' + Date.now());
        setDocumentHash(docHash);
        await sleep(800);

        const ts = new Date().toISOString();
        setTimestamp(ts);
        await sleep(800);

        const combined = docHash + ts;
        const hash1 = await simulateSHA256(combined);
        setFirstHash(hash1);
        await sleep(800);

        const hash2 = await simulateSHA256(hash1);
        setSecondHash(hash2);
        await sleep(800);

        const lastTwoChars = hash2.slice(-2);
        const decimalValue = parseInt(lastTwoChars, 16) % 100;
        setLayerValue(decimalValue);
        await sleep(500);

        let layer;
        if (decimalValue < 70) {
            layer = 1;
        } else if (decimalValue < 90) {
            layer = 2;
        } else {
            layer = 3;
        }
        setSelectedLayer(layer);
        setIsSimulating(false);
    };

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const resetSimulation = () => {
        setDocumentHash('');
        setTimestamp('');
        setFirstHash('');
        setSecondHash('');
        setLayerValue(null);
        setSelectedLayer(null);
    };

    const layers = [
        { 
            id: 1, 
            name: 'Layer 1', 
            icon: 'ğŸ”µ', 
            probability: '70%', 
            range: '0-69',
            description: 'ì¼ë°˜ ë¬¸ì„œ ì €ì¥ ê³„ì¸µ (ë¹ ë¥¸ ê²€ì¦)',
            color: 'border-blue-500'
        },
        { 
            id: 2, 
            name: 'Layer 2', 
            icon: 'ğŸŸ£', 
            probability: '20%', 
            range: '70-89',
            description: 'ì¤‘ìš” ë¬¸ì„œ ì €ì¥ ê³„ì¸µ (ì¤‘ê°„ ê²€ì¦)',
            color: 'border-purple-500'
        },
        { 
            id: 3, 
            name: 'Layer 3', 
            icon: 'ğŸŸ¡', 
            probability: '10%', 
            range: '90-99',
            description: 'ìµœê³  ë³´ì•ˆ ë¬¸ì„œ ì €ì¥ ê³„ì¸µ (ìµœëŒ€ ê²€ì¦)',
            color: 'border-amber-500'
        }
    ];

    return (
        <section className="max-w-7xl mx-auto px-4 py-12">
            <div className="text-center mb-12">
                <h2 className="text-4xl font-bold mb-4 bg-gradient-to-r from-white via-purple-400 to-cyan-400 bg-clip-text text-transparent">
                    ğŸ² í™•ë¥ ì  ê³„ì¸µ ì„ íƒ ì‹œë®¬ë ˆì´í„°
                </h2>
                <p className="text-gray-400 text-lg">SHA-256 ì¬í•´ì‹± ê¸°ë°˜ ê³„ì¸µ ì„ íƒ ê³¼ì •ì„ ì§ì ‘ ì²´í—˜í•˜ì„¸ìš”</p>
            </div>

            <div className="layer-structure mb-12">
                {layers.map(layer => (
                    <div 
                        key={layer.id}
                        className={`layer-box layer-box-${layer.id} ${selectedLayer === layer.id ? 'ring-4 ring-green-400' : ''}`}
                    >
                        <div className="layer-icon">{layer.icon}</div>
                        <div className="layer-details">
                            <div className="layer-title">{layer.name}</div>
                            <div className="layer-description">
                                {layer.description} <span className="text-cyan-400">(ë²”ìœ„: {layer.range})</span>
                            </div>
                        </div>
                        <div className="layer-probability">{layer.probability}</div>
                    </div>
                ))}
            </div>

            <div className="text-center mb-8 flex gap-4 justify-center">
                <button
                    onClick={runSimulation}
                    disabled={isSimulating}
                    className="simulator-button"
                >
                    {isSimulating ? 'â³ ì‹œë®¬ë ˆì´ì…˜ ì¤‘...' : 'â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘'}
                </button>
                {documentHash && (
                    <button
                        onClick={resetSimulation}
                        className="simulator-button secondary-button"
                    >
                        ğŸ”„ ì´ˆê¸°í™”
                    </button>
                )}
            </div>

            {documentHash && (
                <div className="simulator-container">
                    <h3 className="text-2xl font-bold text-center mb-8 text-cyan-400">
                        ğŸ“Š SHA-256 ì¬í•´ì‹± ê³¼ì •
                    </h3>
                    
                    <div className="hash-visualizer">
                        <div className="hash-step">
                            <div className="hash-label">
                                <span>1ï¸âƒ£ ë¬¸ì„œ í•´ì‹œê°’ (Document Hash)</span>
                            </div>
                            <div className="hash-value">{documentHash}</div>
                        </div>

                        {timestamp && (
                            <div className="hash-step">
                                <div className="hash-label">
                                    <span>2ï¸âƒ£ íƒ€ì„ìŠ¤íƒ¬í”„ (Timestamp)</span>
                                </div>
                                <div className="hash-value">{timestamp}</div>
                            </div>
                        )}

                        {firstHash && (
                            <div className="hash-step">
                                <div className="hash-label">
                                    <span>3ï¸âƒ£ 1ì°¨ ì¬í•´ì‹± = SHA-256(ë¬¸ì„œí•´ì‹œ + íƒ€ì„ìŠ¤íƒ¬í”„)</span>
                                </div>
                                <div className="hash-value">{firstHash}</div>
                            </div>
                        )}

                        {secondHash && (
                            <div className="hash-step">
                                <div className="hash-label">
                                    <span>4ï¸âƒ£ 2ì°¨ ì¬í•´ì‹± = SHA-256(1ì°¨ í•´ì‹œ)</span>
                                </div>
                                <div className="hash-value">{secondHash}</div>
                            </div>
                        )}

                        {layerValue !== null && (
                            <div className="hash-step">
                                <div className="hash-label">
                                    <span>5ï¸âƒ£ ê³„ì¸µ ì„ íƒ ê°’ = parseInt(ë§ˆì§€ë§‰ 2ìë¦¬, 16) % 100</span>
                                </div>
                                <div className="hash-value">
                                    ë§ˆì§€ë§‰ 2ìë¦¬: <span className="text-yellow-400">{secondHash.slice(-2)}</span> â†’ 
                                    10ì§„ìˆ˜: <span className="text-yellow-400">{parseInt(secondHash.slice(-2), 16)}</span> â†’ 
                                    ê³„ì¸µ ê°’: <span className="text-green-400 text-2xl font-bold">{layerValue}</span>
                                </div>
                            </div>
                        )}

                        {selectedLayer && (
                            <div className="layer-result">
                                <div className="text-gray-400 text-sm mb-2">ì„ íƒëœ ê³„ì¸µ</div>
                                <div className="layer-badge">
                                    {layers[selectedLayer - 1].icon} Layer {selectedLayer}
                                </div>
                                <div className="text-lg text-gray-300 mt-4">
                                    {layers[selectedLayer - 1].description}
                                </div>
                                <div className="text-sm text-cyan-400 mt-3">
                                    í™•ë¥ : {layers[selectedLayer - 1].probability} | ë²”ìœ„: {layers[selectedLayer - 1].range}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </section>
    );
};
