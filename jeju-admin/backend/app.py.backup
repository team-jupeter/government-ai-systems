from flask import Flask, request, jsonify
from flask_cors import CORS
import anthropic
import os
import logging

app = Flask(__name__)
CORS(app)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

ANTHROPIC_API_KEY = os.environ.get('ANTHROPIC_API_KEY', '')
client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY) if ANTHROPIC_API_KEY else None

SYSTEM_INFO = {
    "system_name": "ì œì£¼ë„ì²­ AI í–‰ì •ì—…ë¬´ ìë™í™” ì‹œìŠ¤í…œ",
    "description": "ì œì£¼íŠ¹ë³„ìì¹˜ë„ í–‰ì • ì „ ë¶„ì•¼ AI í†µí•© í”Œë«í¼",
    "departments": 42,
    "employees": 4500,
    "daily_documents": 12000,
    "automation_rate": "89.5%",
    "budget_managed": "7.2ì¡° ì›"
}

DEPARTMENTS = [
    {"id": "planning", "name": "ê¸°íšì¡°ì •ì‹¤", "icon": "ğŸ“Š", "staff": 120},
    {"id": "admin", "name": "í–‰ì •êµ­", "icon": "ğŸ›ï¸", "staff": 180},
    {"id": "economy", "name": "ê²½ì œì‚°ì—…êµ­", "icon": "ğŸ’¼", "staff": 150},
    {"id": "tourism", "name": "ê´€ê´‘êµ­", "icon": "ğŸï¸", "staff": 130},
    {"id": "welfare", "name": "ë³´ê±´ë³µì§€ì—¬ì„±êµ­", "icon": "â¤ï¸", "staff": 200},
    {"id": "environment", "name": "í™˜ê²½ë³´ì „êµ­", "icon": "ğŸŒ¿", "staff": 140},
    {"id": "construction", "name": "ê±´ì„¤êµí†µêµ­", "icon": "ğŸš§", "staff": 160},
    {"id": "agriculture", "name": "ë†ì¶•ì‚°ì‹í’ˆêµ­", "icon": "ğŸŒ¾", "staff": 110},
    {"id": "culture", "name": "ë¬¸í™”ì²´ìœ¡ëŒ€ì™¸í˜‘ë ¥êµ­", "icon": "ğŸ­", "staff": 90},
    {"id": "safety", "name": "ì•ˆì „ì´ê´„ê³¼", "icon": "ğŸ›¡ï¸", "staff": 80}
]

SCENARIOS = [
    {
        "icon": "ğŸ“",
        "title": "ë¬¸ì„œ ìë™ ì²˜ë¦¬",
        "problem": "ì¼ 12,000ê±´ ë¬¸ì„œ ì²˜ë¦¬ì— ê³µë¬´ì› ì—…ë¬´ì‹œê°„ 60% ì†Œìš”",
        "solution": "AIê°€ ë¬¸ì„œ ë¶„ë¥˜, ìš”ì•½, ê²°ì¬ ë¼ì¸ ìë™ ì¶”ì²œ",
        "savings": "ì—…ë¬´ì‹œê°„ 72% ì ˆê°"
    },
    {
        "icon": "ğŸ’°",
        "title": "ì˜ˆì‚° ìµœì í™”",
        "problem": "7.2ì¡° ì˜ˆì‚° í¸ì„±ì— 3ê°œì›” ì†Œìš”, ë¹„íš¨ìœ¨ ì§‘í–‰ ë°œìƒ",
        "solution": "AIê°€ ê³¼ê±° ë°ì´í„° ë¶„ì„í•˜ì—¬ ìµœì  ì˜ˆì‚° ë°°ë¶„ ì¶”ì²œ",
        "savings": "ì˜ˆì‚° íš¨ìœ¨ 34% í–¥ìƒ"
    },
    {
        "icon": "ğŸ“",
        "title": "ë¯¼ì› ìë™ ì‘ëŒ€",
        "problem": "ì¼ 3,500ê±´ ë¯¼ì› ì „í™”, ê³µë¬´ì› ì‘ëŒ€ í•œê³„",
        "solution": "AIê°€ 24ì‹œê°„ ë¯¼ì› ì‘ëŒ€, ë³µì¡í•œ ê±´ë§Œ ë‹´ë‹¹ì ì—°ê²°",
        "savings": "ë¯¼ì› ì²˜ë¦¬ ì‹œê°„ 85% ë‹¨ì¶•"
    },
    {
        "icon": "ğŸ—“ï¸",
        "title": "ì¼ì • ìµœì í™”",
        "problem": "íšŒì˜, ì¶œì¥, í–‰ì‚¬ ì¼ì • ì¡°ìœ¨ì— ë§ì€ ì‹œê°„ ì†Œìš”",
        "solution": "AIê°€ ì°¸ì„ì ì¼ì •, ì¥ì†Œ, ì¤‘ìš”ë„ ê³ ë ¤í•˜ì—¬ ìµœì  ì¼ì • ìë™ ì¡°ìœ¨",
        "savings": "ì¼ì • ì¡°ìœ¨ ì‹œê°„ 90% ì ˆê°"
    }
]

AGENTS = [
    {"id": "document_assistant", "name": "ğŸ“„ ë¬¸ì„œ ì²˜ë¦¬ Agent"},
    {"id": "budget_advisor", "name": "ğŸ’° ì˜ˆì‚° ë¶„ì„ Agent"},
    {"id": "civil_service", "name": "ğŸ“ ë¯¼ì› ì‘ëŒ€ Agent"},
    {"id": "policy_analyst", "name": "ğŸ“Š ì •ì±… ë¶„ì„ Agent"},
    {"id": "schedule_manager", "name": "ğŸ—“ï¸ ì¼ì • ê´€ë¦¬ Agent"}
]

@app.route('/api/jeju-admin/info', methods=['GET'])
def get_info():
    return jsonify(SYSTEM_INFO)

@app.route('/api/jeju-admin/departments', methods=['GET'])
def get_departments():
    return jsonify({"departments": DEPARTMENTS})

@app.route('/api/jeju-admin/scenarios', methods=['GET'])
def get_scenarios():
    return jsonify({"scenarios": SCENARIOS})

@app.route('/api/jeju-admin/agents', methods=['GET'])
def get_agents():
    return jsonify({"agents": AGENTS})

@app.route('/api/jeju-admin/consultation', methods=['POST', 'OPTIONS'])
def consultation():
    if request.method == 'OPTIONS':
        return '', 204
    
    if not client:
        return jsonify({"response": "âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 200
    
    try:
        data = request.json
        message = data.get('message', '')
        agent_type = data.get('agent_type', 'civil_service')
        
        prompts = {
            "document_assistant": "ë‹¹ì‹ ì€ ì œì£¼ë„ì²­ ë¬¸ì„œ ì²˜ë¦¬ AIì…ë‹ˆë‹¤. ê³µë¬¸ì„œ ì‘ì„±, ê²°ì¬, ë³´ê´€, ê²€ìƒ‰ì„ ì§€ì›í•©ë‹ˆë‹¤.",
            "budget_advisor": "ë‹¹ì‹ ì€ ì œì£¼ë„ì²­ ì˜ˆì‚° ë¶„ì„ AIì…ë‹ˆë‹¤. ì˜ˆì‚° í¸ì„±, ì§‘í–‰, ê²°ì‚° ë¶„ì„ì„ ì§€ì›í•©ë‹ˆë‹¤.",
            "civil_service": "ë‹¹ì‹ ì€ ì œì£¼ë„ì²­ ë¯¼ì› ì‘ëŒ€ AIì…ë‹ˆë‹¤. ë„ë¯¼ì˜ ë¬¸ì˜ì™€ ë¯¼ì›ì„ ì¹œì ˆíˆ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "policy_analyst": "ë‹¹ì‹ ì€ ì œì£¼ë„ì²­ ì •ì±… ë¶„ì„ AIì…ë‹ˆë‹¤. ì •ì±… íš¨ê³¼ ë¶„ì„, ëŒ€ì•ˆ ì œì‹œë¥¼ ì§€ì›í•©ë‹ˆë‹¤.",
            "schedule_manager": "ë‹¹ì‹ ì€ ì œì£¼ë„ì²­ ì¼ì • ê´€ë¦¬ AIì…ë‹ˆë‹¤. íšŒì˜, í–‰ì‚¬, ì¶œì¥ ì¼ì •ì„ ìµœì í™”í•©ë‹ˆë‹¤."
        }
        
        system_prompt = prompts.get(agent_type, prompts["civil_service"])
        system_prompt += "\n\nì œì£¼íŠ¹ë³„ìì¹˜ë„ì˜ í–‰ì • ì—…ë¬´ë¥¼ ì „ë¬¸ì ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤. ì¹œì ˆí•˜ê³  ì •í™•í•˜ê²Œ ì•ˆë‚´í•˜ì„¸ìš”."
        
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1500,
            system=system_prompt,
            messages=[{"role": "user", "content": message}]
        )
        
        return jsonify({"response": response.content[0].text})
        
    except Exception as e:
        return jsonify({"response": f"ì˜¤ë¥˜: {str(e)}"}), 500

@app.route('/api/jeju-admin/process-document', methods=['POST'])
def process_document():
    data = request.json
    doc_type = data.get('type', 'ì¼ë°˜')
    
    result = {
        "document_id": "JJ-DOC-2025-112400001",
        "type": doc_type,
        "status": "ì²˜ë¦¬ì™„ë£Œ",
        "ai_summary": "ì œì£¼ì‹œ ë„ì‹œê³„íš ë³€ê²½ ê´€ë ¨ í˜‘ì˜ ìš”ì²­ ë¬¸ì„œì…ë‹ˆë‹¤.",
        "recommended_department": "ê±´ì„¤êµí†µêµ­",
        "priority": "ë³´í†µ",
        "approval_line": ["ë‹´ë‹¹ì", "íŒ€ì¥", "ê³¼ì¥", "êµ­ì¥"],
        "processed_at": "2025-11-24T07:40:00Z"
    }
    
    return jsonify({"result": result})

@app.route('/api/jeju-admin/budget-analysis', methods=['POST'])
def budget_analysis():
    data = request.json
    department = data.get('department', 'planning')
    
    analysis = {
        "department": department,
        "total_budget": "1,850ì–µ ì›",
        "executed": "1,234ì–µ ì›",
        "execution_rate": "66.7%",
        "remaining": "616ì–µ ì›",
        "ai_recommendation": "4ë¶„ê¸° ì§‘í–‰ë¥  ê°œì„  í•„ìš”. ë¯¸ì§‘í–‰ ì‚¬ì—… 3ê±´ ê²€í†  ê¶Œê³ .",
        "risk_items": [
            {"name": "ë„ë¡œ í™•ì¥ ê³µì‚¬", "risk": "ì˜ˆì‚° ì´ˆê³¼ ì˜ˆìƒ", "solution": "ì„¤ê³„ ë³€ê²½ ê²€í† "}
        ]
    }
    
    return jsonify({"analysis": analysis})

if __name__ == '__main__':
    logger.info("ğŸš€ ì œì£¼ë„ì²­ AI í–‰ì • ì‹œìŠ¤í…œ ë°±ì—”ë“œ ì‹œì‘ (í¬íŠ¸ 5006)")
    app.run(host='0.0.0.0', port=5006, debug=False)
