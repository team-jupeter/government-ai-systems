<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>국가 재무제표 시스템 | OpenHash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Noto Sans KR', sans-serif; }
        :root {
            --gov-blue: #0046FF;
            --gov-blue-dark: #0033CC;
            --gov-blue-light: #E8F0FF;
            --gov-navy: #1e3a5f;
            --gov-gray: #6B7280;
            --gov-bg: #F8F9FA;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.8); opacity: 1; }
        }
        .pulse-ring { animation: pulse-ring 2s ease-in-out infinite; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes flowHash {
            0% { transform: translateY(-20px); opacity: 0; }
            50% { transform: translateY(40px); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        .flow-hash { animation: flowHash 1.5s ease-in-out; }
        .gov-table { border-collapse: collapse; width: 100%; background: white; border: 2px solid var(--gov-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gov-table th { background: var(--gov-blue); color: white; padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.95rem; border-right: 1px solid rgba(255,255,255,0.2); }
        .gov-table th:last-child { border-right: none; }
        .gov-table td { padding: 12px 16px; border-bottom: 1px solid #E5E7EB; color: #1F2937; }
        .gov-table tr:hover { background: #F9FAFB; }
        .gov-table .category-row { background: #F3F4F6; font-weight: 600; color: var(--gov-navy); }
        .gov-table .subcategory-row td { padding-left: 32px; }
        .gov-table .total-row { background: var(--gov-blue-light); font-weight: 700; color: var(--gov-navy); border-top: 2px solid var(--gov-blue); }
        .gov-table .amount { text-align: right; font-family: 'Courier New', monospace; font-weight: 500; }
        .gov-btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: none; cursor: pointer; font-size: 1rem; }
        .gov-btn-primary { background: var(--gov-blue); color: white; }
        .gov-btn-primary:hover { background: var(--gov-blue-dark); }
        .gov-btn-secondary { background: white; color: var(--gov-blue); border: 2px solid var(--gov-blue); }
        .gov-btn-secondary:hover { background: var(--gov-blue-light); }
    </style>
</head>
<body style="background: var(--gov-bg); color: #1F2937;">
    <!-- 데모 배너 -->
    <div class="bg-gray-800 text-white py-3 text-center shadow-lg border-b-2 border-gray-900">
        <p class="text-sm font-semibold">
            ⚠️ 본 사이트는 OpenHash 기술의 실증을 위한 데모 시스템입니다 (실제 정부 서비스 아님)
        </p>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [activeMenu, setActiveMenu] = useState('dashboard');
            const [entities, setEntities] = useState({ businesses: [], individuals: [] });
            const [selectedEntity, setSelectedEntity] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [layersStatus, setLayersStatus] = useState({});
            const [showChat, setShowChat] = useState(false);

            useEffect(() => {
                loadEntities();
                loadTransactions();
                loadLayersStatus();
            }, []);

            const loadEntities = async () => {
                try {
                    const response = await fetch('/api/national-financial-statements/entities');
                    const data = await response.json();
                    setEntities(data);
                } catch (error) {
                    console.error('엔티티 로드 실패:', error);
                }
            };

            const loadTransactions = async () => {
                try {
                    const response = await fetch('/api/national-financial-statements/transactions/history');
                    const data = await response.json();
                    setTransactions(data.transactions || []);
                } catch (error) {
                    console.error('거래 내역 로드 실패:', error);
                }
            };

            const loadLayersStatus = async () => {
                try {
                    const response = await fetch('/api/national-financial-statements/layers/status');
                    const data = await response.json();
                    setLayersStatus(data);
                } catch (error) {
                    console.error('계층 상태 로드 실패:', error);
                }
            };

            const resetToDashboard = () => {
                setActiveMenu('dashboard');
                setSelectedEntity(null);
            };

            return (
                <div className="min-h-screen">
                    <header style={{background: 'white', borderBottom: '3px solid var(--gov-blue)'}} className="sticky top-0 z-50 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4 cursor-pointer hover:opacity-80 transition" onClick={resetToDashboard}>
                                    <div style={{background: 'var(--gov-blue)'}} className="w-14 h-14 rounded-lg flex items-center justify-center shadow-lg">
                                        <i className="fas fa-chart-line text-white text-2xl"></i>
                                    </div>
                                    <div>
                                        <h1 style={{color: 'var(--gov-navy)'}} className="text-2xl font-bold">국가 재무제표 시스템</h1>
                                        <p style={{color: 'var(--gov-gray)'}} className="text-sm">OpenHash 기반 실시간 재무 투명성</p>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <a href="http://100.30.14.224/openhash.html" target="_blank" className="gov-btn gov-btn-secondary">
                                        <i className="fas fa-info-circle mr-2"></i>오픈해시란
                                    </a>
                                    <a href="/portal/systems.html" className="gov-btn gov-btn-secondary">
                                        <i className="fas fa-home mr-2"></i>포털
                                    </a>
                                </div>
                            </div>
                        </div>
                    </header>

                    <nav style={{background: 'white', borderBottom: '1px solid #E5E7EB'}} className="shadow-sm">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex gap-1 overflow-x-auto py-2">
                                {[
                                    { id: 'dashboard', icon: 'fa-dashboard', name: '대시보드' },
                                    { id: 'entities', icon: 'fa-building', name: '개인/사업자' },
                                    { id: 'simulation', icon: 'fa-play', name: '거래 시뮬레이션' },
                                    { id: 'openhash', icon: 'fa-link', name: 'OpenHash 시각화' },
                                    { id: 'analysis', icon: 'fa-brain', name: 'AI 분석' }
                                ].map(menu => (
                                    <button
                                        key={menu.id}
                                        onClick={() => setActiveMenu(menu.id)}
                                        style={{
                                            background: activeMenu === menu.id ? 'var(--gov-blue)' : 'white',
                                            color: activeMenu === menu.id ? 'white' : 'var(--gov-navy)',
                                            border: activeMenu === menu.id ? 'none' : '1px solid #E5E7EB'
                                        }}
                                        className="px-5 py-3 rounded-lg transition whitespace-nowrap font-semibold hover:shadow-md"
                                    >
                                        <i className={`fas ${menu.icon} mr-2`}></i>
                                        {menu.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {activeMenu === 'dashboard' && <Dashboard entities={entities} transactions={transactions} layersStatus={layersStatus} />}
                        {activeMenu === 'entities' && <EntitiesList entities={entities} onSelectEntity={setSelectedEntity} />}
                        {activeMenu === 'simulation' && <TransactionSimulation entities={entities} onTransactionComplete={() => {
                            loadEntities();
                            loadTransactions();
                            loadLayersStatus();
                        }} />}
                        {activeMenu === 'openhash' && <OpenHashVisualization layersStatus={layersStatus} transactions={transactions} />}
                        {activeMenu === 'analysis' && <AIAnalysis transactions={transactions} />}
                    </main>

                    {selectedEntity && <EntityDetailModal entity={selectedEntity} onClose={() => setSelectedEntity(null)} />}
                    
                    {/* AI 상담 Floating 버튼 */}
                    <button 
                        onClick={() => setShowChat(true)}
                        className="fixed bottom-8 right-8 w-16 h-16 rounded-full shadow-2xl hover:scale-110 transition-transform z-40"
                        style={{background: 'var(--gov-blue)'}}
                    >
                        <i className="fas fa-question text-white text-2xl"></i>
                    </button>

                    {/* AI 상담 채팅창 */}
                    {showChat && <AIChatModal onClose={() => setShowChat(false)} />}
                </div>
            );
        };

        const Dashboard = ({ entities, transactions, layersStatus }) => {
            const totalBusinesses = entities.businesses?.length || 0;
            const totalIndividuals = entities.individuals?.length || 0;
            const totalTransactions = transactions?.length || 0;
            const totalNodes = Object.values(layersStatus).reduce((sum, layer) => sum + layer.length, 0);
            return (
                <div className="space-y-6 slide-in">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <StatCard icon="fa-building" label="사업자" value={totalBusinesses} color="#0046FF" />
                        <StatCard icon="fa-users" label="개인" value={totalIndividuals} color="#10B981" />
                        <StatCard icon="fa-exchange-alt" label="총 거래" value={totalTransactions} color="#8B5CF6" />
                        <StatCard icon="fa-network-wired" label="OpenHash 노드" value={totalNodes} color="#06B6D4" />
                    </div>
                    <div style={{background: 'white', border: '2px solid var(--gov-blue)'}} className="rounded-xl p-8 shadow-lg">
                        <h2 style={{color: 'var(--gov-navy)'}} className="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i className="fas fa-shield-alt" style={{color: 'var(--gov-blue)'}}></i>
                            OpenHash 기반 재무 투명성
                        </h2>
                        <div className="grid md:grid-cols-3 gap-6">
                            <FeatureCard icon="fa-link" title="4계층 분산 검증" desc="읍면동 → 시군구 → 광역시도 → 국가" />
                            <FeatureCard icon="fa-ban" title="허위거래 불가" desc="모든 재무제표 상호 연동으로 위변조 차단" />
                            <FeatureCard icon="fa-brain" title="AI 이상거래 감지" desc="Claude AI 실시간 패턴 분석 및 자동 대응" />
                        </div>
                    </div>
                    <div style={{background: 'white'}} className="rounded-xl p-6 shadow-lg">
                        <h2 style={{color: 'var(--gov-navy)'}} className="text-xl font-bold mb-4">최근 거래 내역</h2>
                        {transactions.length === 0 ? (
                            <div className="text-center py-12" style={{color: 'var(--gov-gray)'}}>
                                <i className="fas fa-inbox text-6xl mb-4 opacity-30"></i>
                                <div className="text-lg">아직 거래가 없습니다</div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {transactions.slice(-5).reverse().map((tx, idx) => (
                                    <div key={idx} style={{background: 'var(--gov-bg)', border: '1px solid #E5E7EB'}} className="p-4 rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <div className="font-semibold text-lg" style={{color: 'var(--gov-navy)'}}>{tx.description}</div>
                                                <div className="text-sm mt-1" style={{color: 'var(--gov-gray)'}}>{tx.from} → {tx.to}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xl font-bold" style={{color: 'var(--gov-blue)'}}>{tx.amount?.toLocaleString()}원</div>
                                                <div className="text-xs mt-1" style={{color: 'var(--gov-gray)'}}>{new Date(tx.timestamp).toLocaleString('ko-KR')}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StatCard = ({ icon, label, value, color }) => (
            <div style={{background: 'white'}} className="rounded-xl p-6 shadow-lg hover:shadow-xl transition border border-gray-200">
                <div className="flex items-center justify-between">
                    <div>
                        <div style={{color: 'var(--gov-gray)'}} className="text-sm mb-2 font-medium">{label}</div>
                        <div style={{color: 'var(--gov-navy)'}} className="text-4xl font-bold">{value}</div>
                    </div>
                    <div style={{background: color}} className="w-16 h-16 rounded-xl flex items-center justify-center shadow-md">
                        <i className={`fas ${icon} text-white text-2xl`}></i>
                    </div>
                </div>
            </div>
        );

        const FeatureCard = ({ icon, title, desc }) => (
            <div style={{background: 'var(--gov-blue-light)', border: '1px solid var(--gov-blue)'}} className="p-5 rounded-lg">
                <div className="flex items-start gap-4">
                    <div style={{background: 'var(--gov-blue)'}} className="w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                        <i className={`fas ${icon} text-white text-lg`}></i>
                    </div>
                    <div>
                        <div className="font-bold text-lg mb-2" style={{color: 'var(--gov-navy)'}}>{title}</div>
                        <div className="text-sm leading-relaxed" style={{color: 'var(--gov-gray)'}}>{desc}</div>
                    </div>
                </div>
            </div>
        );

        const EntitiesList = ({ entities, onSelectEntity }) => {
            const [filter, setFilter] = useState('all');
            const filteredEntities = filter === 'all' ? [...(entities.businesses || []), ...(entities.individuals || [])] : filter === 'business' ? entities.businesses || [] : entities.individuals || [];
            return (
                <div className="space-y-6 slide-in">
                    <div style={{background: 'white'}} className="rounded-xl p-6 shadow-lg">
                        <div className="flex gap-3">
                            {[
                                { id: 'all', name: '전체', icon: 'fa-list' },
                                { id: 'business', name: '사업자', icon: 'fa-building' },
                                { id: 'individual', name: '개인', icon: 'fa-user' }
                            ].map(f => (
                                <button key={f.id} onClick={() => setFilter(f.id)} className="gov-btn" style={{ background: filter === f.id ? 'var(--gov-blue)' : 'white', color: filter === f.id ? 'white' : 'var(--gov-blue)', border: `2px solid var(--gov-blue)` }}>
                                    <i className={`fas ${f.icon} mr-2`}></i>{f.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    {filteredEntities.length === 0 ? (
                        <div style={{background: 'white'}} className="rounded-xl p-12 text-center shadow-lg">
                            <i className="fas fa-inbox text-6xl mb-4 opacity-20" style={{color: 'var(--gov-gray)'}}></i>
                            <div style={{color: 'var(--gov-gray)'}}>데이터를 불러오는 중...</div>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredEntities.map(entity => (
                                <div key={entity.id} onClick={() => onSelectEntity(entity)} style={{background: 'white', border: '2px solid #E5E7EB'}} className="p-6 rounded-xl cursor-pointer hover:shadow-xl transition hover:border-blue-500">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="flex items-center gap-3">
                                            <div style={{background: 'var(--gov-blue-light)', color: 'var(--gov-blue)'}} className="w-12 h-12 rounded-lg flex items-center justify-center">
                                                <i className={`fas ${entity.type ? 'fa-building' : 'fa-user'} text-xl`}></i>
                                            </div>
                                            <div>
                                                <div className="font-bold text-lg" style={{color: 'var(--gov-navy)'}}>{entity.name}</div>
                                                <span className="text-xs px-3 py-1 rounded-full" style={{background: 'var(--gov-blue-light)', color: 'var(--gov-blue)'}}>{entity.id}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-sm mb-4" style={{color: 'var(--gov-gray)'}}>{entity.type || entity.occupation}</div>
                                    <div className="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                                        <div>
                                            <div className="text-xs mb-1" style={{color: 'var(--gov-gray)'}}>총자산</div>
                                            <div className="font-bold text-lg text-green-600">{(entity.balance_sheet?.assets?.total || 0).toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs mb-1" style={{color: 'var(--gov-gray)'}}>순이익</div>
                                            <div className="font-bold text-lg" style={{color: 'var(--gov-blue)'}}>{(entity.income_statement?.net_income || 0).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const TransactionSimulation = ({ entities, onTransactionComplete }) => {
            const [fromEntity, setFromEntity] = useState('');
            const [toEntity, setToEntity] = useState('');
            const [amount, setAmount] = useState(10000000);
            const [description, setDescription] = useState('상품 구매');
            const [showModal, setShowModal] = useState(false);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [animationStep, setAnimationStep] = useState(0);
            const [currentMessage, setCurrentMessage] = useState('');
            const [activeLayer, setActiveLayer] = useState(null);
            const [showHashFlow, setShowHashFlow] = useState(false);
            const [layerConnections, setLayerConnections] = useState({});
            const [currentHash, setCurrentHash] = useState('');
            const [hashChains, setHashChains] = useState({
                transaction: [],
                layer1: [],
                layer2: [],
                layer3: [],
                layer4: []
            });

            const allEntities = [...(entities.businesses || []), ...(entities.individuals || [])];

            const generateHash = (data) => {
                const chars = '0123456789abcdef';
                let hash = '';
                for (let i = 0; i < 12; i++) {
                    hash += chars[Math.floor(Math.random() * chars.length)];
                }
                return hash;
            };

            const animationSteps = [
                { step: 0, message: "거래 데이터로부터 Hash를 생성합니다.", duration: 2500, layer: 'transaction', action: 'generate_hash' },
                { step: 1, message: "거래 데이터 Hash를 Layer 1으로 보내고, Layer 1의 Hash Chain을 갱신합니다.", duration: 3000, layer: 'layer1', action: 'send_to_layer', connection: 'connection1' },
                { step: 2, message: "Layer 1이 Hash Chain을 갱신하고, 최종 Hash를 거래당사자에게 답신합니다.", duration: 2500, layer: 'layer1', action: 'response' },
                { step: 3, message: "이제, 거래 당사자와 Layer 1의 Hash Chain이 상호 연동되었습니다.", duration: 2000, layer: 'connection1', action: 'linked' },
                { step: 4, message: "거래당사자가 Layer 1으로부터 답신받은 Hash로 자신의 최종 Hash를 갱신합니다.", duration: 2500, layer: 'transaction', action: 'update_hash' },
                { step: 5, message: "Layer 1의 최종 Hash를 Layer 2로 전송하고, 동일한 메커니즘으로 Layer 1과 Layer 2의 Hash Chain을 상호 연동합니다.", duration: 3000, layer: 'layer2', action: 'send_to_layer', connection: 'connection2' },
                { step: 6, message: "Layer 2와 Layer 3 간에도 동일한 메커니즘으로 상호 Hash Chain을 연동합니다.", duration: 3000, layer: 'layer3', action: 'send_to_layer', connection: 'connection3' },
                { step: 7, message: "Layer 3와 Layer 4도 동일한 메커니즘으로 상호 Hash Chain을 연동합니다.", duration: 3000, layer: 'layer4', action: 'send_to_layer', connection: 'connection4' },
                { step: 8, message: "거래 당사자와 Hash를 연동하는 Layer는 사전에 결정되지 않고, Layer 1, 2, 3, 4 중 어느 하나로 확률적으로 결정됩니다.", duration: 3500, layer: 'all', action: 'probability' },
                { step: 9, message: "모든 계층의 Hash Chain이 성공적으로 연동되었습니다. 거래가 완료되었습니다.", duration: 2000, layer: 'complete', action: 'complete' }
            ];

            useEffect(() => {
                if (loading && animationStep < animationSteps.length) {
                    const currentStepData = animationSteps[animationStep];
                    setCurrentMessage(currentStepData.message);
                    setActiveLayer(currentStepData.layer);
                    
                    if (currentStepData.action === 'generate_hash') {
                        const hash = generateHash('transaction');
                        setCurrentHash(hash);
                        setHashChains(prev => ({...prev, transaction: [...prev.transaction, hash]}));
                    }
                    
                    if (currentStepData.action === 'send_to_layer') {
                        setShowHashFlow(true);
                        setTimeout(() => {
                            const hash = generateHash(currentStepData.layer);
                            setCurrentHash(hash);
                            setHashChains(prev => ({...prev, [currentStepData.layer]: [...prev[currentStepData.layer], hash]}));
                            setShowHashFlow(false);
                            if (currentStepData.connection) {
                                setLayerConnections(prev => ({...prev, [currentStepData.connection]: true}));
                            }
                        }, 1500);
                    }
                    
                    if (currentStepData.action === 'linked') {
                        setLayerConnections(prev => ({...prev, [currentStepData.layer]: true}));
                    }
                    
                    if (currentStepData.action === 'update_hash') {
                        const hash = generateHash('transaction_update');
                        setCurrentHash(hash);
                        setHashChains(prev => ({...prev, transaction: [...prev.transaction, hash]}));
                    }
                    
                    const timer = setTimeout(() => {
                        setAnimationStep(animationStep + 1);
                    }, currentStepData.duration);
                    
                    return () => clearTimeout(timer);
                }
            }, [loading, animationStep]);

            const simulateTransaction = async () => {
                if (!fromEntity || !toEntity) {
                    alert('송신자와 수신자를 선택해주세요');
                    return;
                }
                if (fromEntity === toEntity) {
                    alert('송신자와 수신자가 동일할 수 없습니다');
                    return;
                }

                setShowModal(true);
                setLoading(true);
                setAnimationStep(0);
                setResult(null);
                setLayerConnections({});
                setHashChains({
                    transaction: [],
                    layer1: [],
                    layer2: [],
                    layer3: [],
                    layer4: []
                });
                setCurrentHash('');

                try {
                    const response = await fetch('/api/national-financial-statements/transaction/simulate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ from: fromEntity, to: toEntity, amount: parseInt(amount), description: description })
                    });

                    const data = await response.json();
                    const totalDuration = animationSteps.reduce((sum, step) => sum + step.duration, 0);
                    await new Promise(resolve => setTimeout(resolve, totalDuration));
                    
                    setResult(data);
                    onTransactionComplete();
                } catch (error) {
                    console.error('거래 시뮬레이션 실패:', error);
                    alert('거래 시뮬레이션 중 오류가 발생했습니다');
                    setShowModal(false);
                } finally {
                    setLoading(false);
                    setAnimationStep(0);
                }
            };

            const closeModal = () => {
                setShowModal(false);
                setResult(null);
            };

            return (
                <div className="space-y-6 slide-in">
                    <div style={{background: 'white'}} className="rounded-xl p-8 shadow-lg">
                        <h2 style={{color: 'var(--gov-navy)'}} className="text-2xl font-bold mb-6 flex items-center gap-3">
                            <i className="fas fa-play" style={{color: 'var(--gov-blue)'}}></i>
                            거래 시뮬레이션
                        </h2>
                        
                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--gov-navy)'}}>
                                    <i className="fas fa-user-circle mr-2"></i>송신자 (지불)
                                </label>
                                <select value={fromEntity} onChange={(e) => setFromEntity(e.target.value)} style={{border: '2px solid var(--gov-blue)'}} className="w-full rounded-lg px-4 py-3">
                                    <option value="">선택하세요</option>
                                    {allEntities.map(e => (<option key={e.id} value={e.id}>{e.name} ({e.id})</option>))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--gov-navy)'}}>
                                    <i className="fas fa-user-check mr-2"></i>수신자 (수령)
                                </label>
                                <select value={toEntity} onChange={(e) => setToEntity(e.target.value)} style={{border: '2px solid var(--gov-blue)'}} className="w-full rounded-lg px-4 py-3">
                                    <option value="">선택하세요</option>
                                    {allEntities.map(e => (<option key={e.id} value={e.id}>{e.name} ({e.id})</option>))}
                                </select>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--gov-navy)'}}>
                                    <i className="fas fa-won-sign mr-2"></i>거래 금액 (원)
                                </label>
                                <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} style={{border: '2px solid var(--gov-blue)'}} className="w-full rounded-lg px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-2" style={{color: 'var(--gov-navy)'}}>
                                    <i className="fas fa-file-alt mr-2"></i>거래 설명
                                </label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} style={{border: '2px solid var(--gov-blue)'}} className="w-full rounded-lg px-4 py-3" />
                            </div>
                        </div>

                        <button onClick={simulateTransaction} className="gov-btn gov-btn-primary w-full text-lg">
                            <i className="fas fa-play mr-2"></i>거래 시뮬레이션 시작
                        </button>
                    </div>

                    {/* Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" style={{animation: 'slideIn 0.3s ease-out'}}>
                            <div style={{background: 'white', maxHeight: '90vh'}} className="rounded-2xl w-full max-w-4xl overflow-y-auto shadow-2xl">
                                <div className="sticky top-0 bg-white border-b-4 p-6 shadow-md z-10" style={{borderColor: 'var(--gov-blue)'}}>
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-2xl font-bold" style={{color: 'var(--gov-navy)'}}>
                                            <i className="fas fa-chart-network mr-3" style={{color: 'var(--gov-blue)'}}></i>
                                            OpenHash 거래 처리 중
                                        </h3>
                                        {!loading && result && (
                                            <button onClick={closeModal} className="w-10 h-10 rounded-lg hover:bg-gray-100 transition">
                                                <i className="fas fa-times text-2xl" style={{color: 'var(--gov-gray)'}}></i>
                                            </button>
                                        )}
                                    </div>
                                </div>

                                <div className="p-8">
                                    {loading && (
                                        <div>
                                            {/* 메시지 박스 */}
                                            <div className="mb-8 p-6 rounded-lg" style={{background: 'var(--gov-blue-light)', border: '2px solid var(--gov-blue)'}}>
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 rounded-full flex items-center justify-center pulse-ring" style={{background: 'var(--gov-blue)'}}>
                                                        <i className="fas fa-info text-white text-xl"></i>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="font-bold text-lg" style={{color: 'var(--gov-navy)'}}>단계 {animationStep + 1} / {animationSteps.length}</div>
                                                        <div className="mt-2 text-base leading-relaxed" style={{color: 'var(--gov-gray)'}}>{currentMessage}</div>
                                                        {currentHash && (
                                                            <div className="mt-3 p-3 rounded-lg font-mono text-sm" style={{background: 'white', color: 'var(--gov-blue)', border: '1px solid var(--gov-blue)'}}>
                                                                <span className="font-bold">현재 Hash:</span> {currentHash}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 애니메이션 영역 */}
                                            <div className="relative">
                                                {/* 거래 당사자 */}
                                                <div className="flex justify-center mb-6">
                                                    <div className={`p-6 rounded-xl border-4 transition-all duration-500 ${activeLayer === 'transaction' ? 'scale-110 shadow-2xl' : ''}`} style={{ background: activeLayer === 'transaction' ? 'var(--gov-blue-light)' : 'white', borderColor: activeLayer === 'transaction' ? 'var(--gov-blue)' : '#E5E7EB' }}>
                                                        <div className="text-center">
                                                            <i className="fas fa-handshake text-4xl mb-2" style={{color: 'var(--gov-blue)'}}></i>
                                                            <div className="font-bold text-lg">거래 당사자</div>
                                                            <div className="text-sm mt-2 font-mono" style={{color: 'var(--gov-gray)'}}>{fromEntity} ⇄ {toEntity}</div>
                                                            {hashChains.transaction.length > 0 && (
                                                                <div className="mt-3 p-2 rounded text-xs" style={{background: '#F3F4F6'}}>
                                                                    <div className="font-bold mb-1">Hash Chain: {hashChains.transaction.length}개</div>
                                                                    <div className="font-mono text-xs truncate" style={{color: 'var(--gov-blue)'}}>최신: {hashChains.transaction[hashChains.transaction.length - 1]}</div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Hash 흐름 */}
                                                {showHashFlow && (<div className="flex justify-center mb-4"><div className="flow-hash"><i className="fas fa-arrow-down text-4xl" style={{color: 'var(--gov-blue)'}}></i></div></div>)}

                                                {/* Layer 1-4 */}
                                                <div className="space-y-3">
                                                    {[
                                                        { id: 'layer1', name: 'Layer 1: 읍면동', icon: 'fa-home', color: '#10B981', connection: 'connection1' },
                                                        { id: 'layer2', name: 'Layer 2: 시군구', icon: 'fa-building', color: '#06B6D4', connection: 'connection2' },
                                                        { id: 'layer3', name: 'Layer 3: 광역시도', icon: 'fa-city', color: '#0046FF', connection: 'connection3' },
                                                        { id: 'layer4', name: 'Layer 4: 국가', icon: 'fa-flag', color: '#8B5CF6', connection: 'connection4' }
                                                    ].map((layer, idx) => (
                                                        <div key={layer.id}>
                                                            <div className={`p-5 rounded-xl border-4 transition-all duration-500 ${activeLayer === layer.id || activeLayer === 'all' ? 'scale-105 shadow-xl' : ''}`} style={{ background: activeLayer === layer.id || activeLayer === 'all' ? layer.color + '20' : 'white', borderColor: activeLayer === layer.id || activeLayer === 'all' ? layer.color : '#E5E7EB' }}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="w-14 h-14 rounded-xl flex items-center justify-center text-white text-xl shadow-lg flex-shrink-0" style={{background: layer.color}}>
                                                                        <i className={`fas ${layer.icon}`}></i>
                                                                    </div>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="font-bold text-base" style={{color: 'var(--gov-navy)'}}>{layer.name}</div>
                                                                        {hashChains[layer.id].length > 0 && (
                                                                            <div className="mt-2 p-2 rounded text-xs" style={{background: layer.color + '10'}}>
                                                                                <div className="font-bold">Chain: {hashChains[layer.id].length}개</div>
                                                                                <div className="font-mono text-xs truncate" style={{color: layer.color}}>최신: {hashChains[layer.id][hashChains[layer.id].length - 1]}</div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    {activeLayer === layer.id && (<div className="pulse-ring flex-shrink-0"><i className="fas fa-sync-alt text-2xl" style={{color: layer.color}}></i></div>)}
                                                                </div>
                                                            </div>
                                                            {/* 연결 아이콘 */}
                                                            {idx < 3 && layerConnections[layer.connection] && (
                                                                <div className="flex justify-center my-2">
                                                                    <i className="fas fa-link text-2xl text-green-500 animate-pulse"></i>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>

                                                {/* 확률적 선택 알림 */}
                                                {activeLayer === 'all' && (
                                                    <div className="mt-6 p-5 rounded-lg" style={{background: '#FEF3C7', border: '2px solid #F59E0B'}}>
                                                        <div className="flex items-center gap-3">
                                                            <i className="fas fa-dice text-3xl text-yellow-600"></i>
                                                            <div className="font-bold text-base" style={{color: '#92400E'}}>확률적 계층 선택: 각 거래마다 무작위로 Layer가 선택됩니다</div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 완료 */}
                                                {activeLayer === 'complete' && (
                                                    <div className="mt-6 p-5 rounded-lg" style={{background: '#DCFCE7', border: '2px solid #10B981'}}>
                                                        <div className="flex items-center gap-3">
                                                            <i className="fas fa-check-circle text-4xl text-green-600"></i>
                                                            <div className="font-bold text-xl text-green-800">거래 완료! 모든 Hash Chain이 연동되었습니다.</div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* 결과 */}
                                    {result && result.success && !loading && (
                                        <div>
                                            <div className="flex items-center gap-3 mb-6">
                                                <i className="fas fa-check-circle text-green-500 text-3xl"></i>
                                                <h4 className="text-2xl font-bold" style={{color: 'var(--gov-navy)'}}>거래 완료</h4>
                                            </div>
                                            {result.transaction.from_before && result.transaction.from_after && (
                                                <div className="mb-6">
                                                    <h5 className="font-bold text-lg mb-4" style={{color: 'var(--gov-navy)'}}>
                                                        <i className="fas fa-chart-bar mr-2"></i>재무제표 변경사항
                                                    </h5>
                                                    <div className="grid md:grid-cols-2 gap-6">
                                                        <div style={{border: '2px solid #FEE2E2'}} className="p-4 rounded-lg bg-red-50">
                                                            <div className="font-bold mb-3 text-red-700">{result.transaction.from} (송신자)</div>
                                                            <div className="text-sm">
                                                                <div className="flex justify-between">
                                                                    <span>현금:</span>
                                                                    <span className="font-mono">{result.transaction.from_before.balance_sheet.assets.current.cash.toLocaleString()} → <span className="text-red-600 font-bold">{result.transaction.from_after.balance_sheet.assets.current.cash.toLocaleString()}</span></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style={{border: '2px solid #DCFCE7'}} className="p-4 rounded-lg bg-green-50">
                                                            <div className="font-bold mb-3 text-green-700">{result.transaction.to} (수신자)</div>
                                                            <div className="text-sm">
                                                                <div className="flex justify-between">
                                                                    <span>현금:</span>
                                                                    <span className="font-mono">{result.transaction.to_before.balance_sheet.assets.current.cash.toLocaleString()} → <span className="text-green-600 font-bold">{result.transaction.to_after.balance_sheet.assets.current.cash.toLocaleString()}</span></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            <button onClick={closeModal} className="gov-btn gov-btn-primary w-full">
                                                <i className="fas fa-check mr-2"></i>확인
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const OpenHashVisualization = () => (
            <div style={{background: 'white'}} className="rounded-xl p-8 text-center shadow-lg">
                <h2 className="text-2xl font-bold mb-4" style={{color: 'var(--gov-navy)'}}>OpenHash 시각화</h2>
                <p style={{color: 'var(--gov-gray)'}}>준비 중...</p>
            </div>
        );

        const AIAnalysis = () => (
            <div style={{background: 'white'}} className="rounded-xl p-8 text-center shadow-lg">
                <h2 className="text-2xl font-bold mb-4" style={{color: 'var(--gov-navy)'}}>AI 분석</h2>
                <p style={{color: 'var(--gov-gray)'}}>준비 중...</p>
            </div>
        );


        // AI 상담 채팅 Modal
        const AIChatModal = ({ onClose }) => {
            const [messages, setMessages] = useState([
                { role: 'assistant', content: '안녕하세요! OpenHash 기반 국가 재무제표 시스템 AI 상담원입니다. 무엇을 도와드릴까요?' }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = React.useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(scrollToBottom, [messages]);

            const sendMessage = async () => {
                if (!inputMessage.trim() || loading) return;

                const userMessage = inputMessage.trim();
                setInputMessage('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setLoading(true);

                try {
                    const response = await fetch('/api/national-financial-statements/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: userMessage,
                            history: messages
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setMessages(prev => [...prev, { role: 'assistant', content: data.message }]);
                    } else {
                        setMessages(prev => [...prev, { role: 'assistant', content: '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.' }]);
                    }
                } catch (error) {
                    console.error('채팅 오류:', error);
                    setMessages(prev => [...prev, { role: 'assistant', content: '죄송합니다. 연결 오류가 발생했습니다.' }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="fixed bottom-28 right-8 w-96 rounded-2xl shadow-2xl z-50" style={{background: 'white', maxHeight: '600px', display: 'flex', flexDirection: 'column'}}>
                    {/* 헤더 */}
                    <div className="p-4 border-b-4 rounded-t-2xl" style={{background: 'var(--gov-blue)', borderColor: 'var(--gov-blue-dark)'}}>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center">
                                    <i className="fas fa-robot" style={{color: 'var(--gov-blue)'}}></i>
                                </div>
                                <div>
                                    <div className="font-bold text-white">AI 상담원</div>
                                    <div className="text-xs text-white/80">OpenHash 시스템 안내</div>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-white hover:bg-white/20 w-8 h-8 rounded-lg transition">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    {/* 메시지 영역 */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3" style={{maxHeight: '450px', background: '#F8F9FA'}}>
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-white border-2'}`} style={msg.role === 'assistant' ? {borderColor: 'var(--gov-blue-light)'} : {}}>
                                    <div className="text-sm leading-relaxed whitespace-pre-wrap">{msg.content}</div>
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white border-2 p-3 rounded-lg" style={{borderColor: 'var(--gov-blue-light)'}}>
                                    <i className="fas fa-spinner fa-spin" style={{color: 'var(--gov-blue)'}}></i>
                                    <span className="ml-2 text-sm">답변 생성 중...</span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* 입력 영역 */}
                    <div className="p-4 border-t" style={{background: 'white'}}>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="메시지를 입력하세요..."
                                className="flex-1 px-4 py-2 border-2 rounded-lg focus:outline-none focus:ring-2"
                                style={{borderColor: 'var(--gov-blue)', focusRing: 'var(--gov-blue)'}}
                                disabled={loading}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={loading || !inputMessage.trim()}
                                className="px-4 py-2 rounded-lg text-white font-semibold transition"
                                style={{background: 'var(--gov-blue)', opacity: loading || !inputMessage.trim() ? 0.5 : 1}}
                            >
                                <i className="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const EntityDetailModal = () => null;

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
