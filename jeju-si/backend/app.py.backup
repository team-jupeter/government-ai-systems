from flask import Flask, request, jsonify
from flask_cors import CORS
import anthropic
import os
import logging

app = Flask(__name__)
CORS(app)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

ANTHROPIC_API_KEY = os.environ.get('ANTHROPIC_API_KEY', '')
client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY) if ANTHROPIC_API_KEY else None

SYSTEM_INFO = {
    "system_name": "ì œì£¼ì‹œì²­ AI í–‰ì •ì—…ë¬´ ìë™í™” ì‹œìŠ¤í…œ",
    "description": "ì œì£¼ì‹œ í–‰ì • ì„œë¹„ìŠ¤ AI í†µí•© í”Œë«í¼",
    "population": 492000,
    "area": "977.8kmÂ²",
    "departments": 28,
    "employees": 1850,
    "daily_services": 8500,
    "automation_rate": "86.3%"
}

DEPARTMENTS = [
    {"id": "mayor", "name": "ì‹œì¥ì‹¤", "icon": "ğŸ›ï¸", "staff": 25},
    {"id": "planning", "name": "ê¸°íšì‹¤", "icon": "ğŸ“Š", "staff": 45},
    {"id": "admin", "name": "ì´ë¬´ê³¼", "icon": "ğŸ“", "staff": 80},
    {"id": "finance", "name": "ì¬ë¬´ê³¼", "icon": "ğŸ’°", "staff": 65},
    {"id": "civil", "name": "ë¯¼ì›ë´‰ì‚¬ê³¼", "icon": "ğŸ“", "staff": 120},
    {"id": "welfare", "name": "ì£¼ë¯¼ë³µì§€ê³¼", "icon": "â¤ï¸", "staff": 95},
    {"id": "economy", "name": "ê²½ì œì‚°ì—…ê³¼", "icon": "ğŸ’¼", "staff": 70},
    {"id": "culture", "name": "ë¬¸í™”ê´€ê´‘ê³¼", "icon": "ğŸ­", "staff": 55},
    {"id": "urban", "name": "ë„ì‹œê³¼", "icon": "ğŸ—ï¸", "staff": 85},
    {"id": "environment", "name": "í™˜ê²½ê³¼", "icon": "ğŸŒ¿", "staff": 60},
    {"id": "traffic", "name": "êµí†µí–‰ì •ê³¼", "icon": "ğŸš—", "staff": 50},
    {"id": "safety", "name": "ì•ˆì „ì´ê´„ê³¼", "icon": "ğŸ›¡ï¸", "staff": 45}
]

LOCAL_SERVICES = [
    {"id": "parking", "name": "ì£¼ì°¨ì¥ ê´€ë¦¬", "type": "êµí†µ", "online": True},
    {"id": "waste", "name": "íê¸°ë¬¼ ìˆ˜ê±°", "type": "í™˜ê²½", "online": True},
    {"id": "streetlight", "name": "ê°€ë¡œë“± ë¯¼ì›", "type": "ì‹œì„¤", "online": True},
    {"id": "pothole", "name": "ë„ë¡œ íŒŒì† ì‹ ê³ ", "type": "ì‹œì„¤", "online": True},
    {"id": "noise", "name": "ì†ŒìŒ ì‹ ê³ ", "type": "í™˜ê²½", "online": True},
    {"id": "business", "name": "ì˜ì—…í—ˆê°€ ì‹ ì²­", "type": "ê²½ì œ", "online": True},
    {"id": "building", "name": "ê±´ì¶• í—ˆê°€", "type": "ë„ì‹œ", "online": True},
    {"id": "event", "name": "í–‰ì‚¬ ì¥ì†Œ ëŒ€ì—¬", "type": "ë¬¸í™”", "online": True}
]

SCENARIOS = [
    {
        "icon": "ğŸš—",
        "title": "ìŠ¤ë§ˆíŠ¸ ì£¼ì°¨ ì‹œìŠ¤í…œ",
        "problem": "ì£¼ì°¨ ê³µê°„ ì°¾ê¸°ì— í‰ê·  15ë¶„ ì†Œìš”, ë¶ˆë²• ì£¼ì°¨ ë‹¨ì† ì–´ë ¤ì›€",
        "solution": "AIê°€ ì‹¤ì‹œê°„ ì£¼ì°¨ í˜„í™© ì•ˆë‚´, ë¶ˆë²• ì£¼ì°¨ ìë™ íƒì§€",
        "savings": "ì£¼ì°¨ ì‹œê°„ 78% ë‹¨ì¶•"
    },
    {
        "icon": "ğŸ—‘ï¸",
        "title": "ìŠ¤ë§ˆíŠ¸ íê¸°ë¬¼ ê´€ë¦¬",
        "problem": "ê³ ì • ë…¸ì„  ìˆ˜ê±°ë¡œ ë¹„íš¨ìœ¨, ì¼ë¶€ ì§€ì—­ ìˆ˜ê±° ì§€ì—°",
        "solution": "AIê°€ ì“°ë ˆê¸°ëŸ‰ ì˜ˆì¸¡í•˜ì—¬ ìµœì  ìˆ˜ê±° ê²½ë¡œ ìƒì„±",
        "savings": "ìˆ˜ê±° ë¹„ìš© 32% ì ˆê°"
    },
    {
        "icon": "ğŸ”§",
        "title": "ì‹œì„¤ë¬¼ ìë™ ì ê²€",
        "problem": "ë„ë¡œ, ê°€ë¡œë“± ë“± ì‹œì„¤ë¬¼ ì ê²€ ì¸ë ¥ ë¶€ì¡±",
        "solution": "AI+IoTë¡œ ì‹œì„¤ë¬¼ ìƒíƒœ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§, ì´ìƒ ìë™ ê°ì§€",
        "savings": "ì‚¬ê³  ì˜ˆë°©ë¥  89% í–¥ìƒ"
    },
    {
        "icon": "ğŸ“Š",
        "title": "ë¯¼ì› ì˜ˆì¸¡ ì‹œìŠ¤í…œ",
        "problem": "ë¯¼ì› í­ì£¼ ì‹œ ëŒ€ì‘ ì–´ë ¤ì›€, ê³„ì ˆë³„ ë¯¼ì› íŒ¨í„´ íŒŒì•… ì–´ë ¤ì›€",
        "solution": "AIê°€ ë¯¼ì› íŒ¨í„´ ë¶„ì„, ìˆ˜ìš” ì˜ˆì¸¡í•˜ì—¬ ì‚¬ì „ ì¸ë ¥ ë°°ì¹˜",
        "savings": "ë¯¼ì› ì²˜ë¦¬ ëŒ€ê¸° ì‹œê°„ 65% ë‹¨ì¶•"
    }
]

AGENTS = [
    {"id": "civil_service", "name": "ğŸ“ ë¯¼ì› ìƒë‹´ Agent"},
    {"id": "parking_guide", "name": "ğŸš— ì£¼ì°¨ ì•ˆë‚´ Agent"},
    {"id": "facility_report", "name": "ğŸ”§ ì‹œì„¤ ì‹ ê³  Agent"},
    {"id": "permit_guide", "name": "ğŸ“‹ ì¸í—ˆê°€ ì•ˆë‚´ Agent"},
    {"id": "local_info", "name": "ğŸ“ ì§€ì—­ ì •ë³´ Agent"}
]

@app.route('/api/jeju-si/info', methods=['GET'])
def get_info():
    return jsonify(SYSTEM_INFO)

@app.route('/api/jeju-si/departments', methods=['GET'])
def get_departments():
    return jsonify({"departments": DEPARTMENTS})

@app.route('/api/jeju-si/services', methods=['GET'])
def get_services():
    return jsonify({"services": LOCAL_SERVICES})

@app.route('/api/jeju-si/scenarios', methods=['GET'])
def get_scenarios():
    return jsonify({"scenarios": SCENARIOS})

@app.route('/api/jeju-si/agents', methods=['GET'])
def get_agents():
    return jsonify({"agents": AGENTS})

@app.route('/api/jeju-si/consultation', methods=['POST', 'OPTIONS'])
def consultation():
    if request.method == 'OPTIONS':
        return '', 204
    
    if not client:
        return jsonify({"response": "âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 200
    
    try:
        data = request.json
        message = data.get('message', '')
        agent_type = data.get('agent_type', 'civil_service')
        
        prompts = {
            "civil_service": "ë‹¹ì‹ ì€ ì œì£¼ì‹œì²­ ë¯¼ì› ìƒë‹´ AIì…ë‹ˆë‹¤. ì œì£¼ì‹œë¯¼ì˜ ê°ì¢… ë¬¸ì˜ì™€ ë¯¼ì›ì„ ì¹œì ˆíˆ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "parking_guide": "ë‹¹ì‹ ì€ ì œì£¼ì‹œ ì£¼ì°¨ ì•ˆë‚´ AIì…ë‹ˆë‹¤. ê³µì˜ì£¼ì°¨ì¥ ìœ„ì¹˜, ìš”ê¸ˆ, ì‹¤ì‹œê°„ í˜„í™©ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "facility_report": "ë‹¹ì‹ ì€ ì‹œì„¤ë¬¼ ì‹ ê³  AIì…ë‹ˆë‹¤. ë„ë¡œ, ê°€ë¡œë“±, ê³µì› ë“± ì‹œì„¤ë¬¼ ê³ ì¥/íŒŒì† ì‹ ê³ ë¥¼ ì ‘ìˆ˜í•©ë‹ˆë‹¤.",
            "permit_guide": "ë‹¹ì‹ ì€ ì¸í—ˆê°€ ì•ˆë‚´ AIì…ë‹ˆë‹¤. ì˜ì—…í—ˆê°€, ê±´ì¶•í—ˆê°€ ë“± ê°ì¢… ì¸í—ˆê°€ ì ˆì°¨ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "local_info": "ë‹¹ì‹ ì€ ì œì£¼ì‹œ ì§€ì—­ ì •ë³´ AIì…ë‹ˆë‹¤. ê´€ê´‘ì§€, í–‰ì‚¬, ë§›ì§‘, êµí†µ ì •ë³´ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤."
        }
        
        system_prompt = prompts.get(agent_type, prompts["civil_service"])
        system_prompt += "\n\nì œì£¼ì‹œì²­ì˜ AI ë¯¼ì› ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì œì£¼ì‹œë¯¼ì—ê²Œ ì¹œì ˆí•˜ê³  ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”."
        
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1500,
            system=system_prompt,
            messages=[{"role": "user", "content": message}]
        )
        
        return jsonify({"response": response.content[0].text})
        
    except Exception as e:
        return jsonify({"response": f"ì˜¤ë¥˜: {str(e)}"}), 500

@app.route('/api/jeju-si/parking-status', methods=['GET'])
def parking_status():
    parking_lots = [
        {"name": "ì œì£¼ì‹œì²­ ê³µì˜ì£¼ì°¨ì¥", "total": 350, "available": 45, "fee": "ë¬´ë£Œ"},
        {"name": "ì¤‘ì•™ë¡œ ì§€í•˜ì£¼ì°¨ì¥", "total": 500, "available": 123, "fee": "ì‹œê°„ë‹¹ 1,000ì›"},
        {"name": "íƒ‘ë™ ê³µì˜ì£¼ì°¨ì¥", "total": 280, "available": 67, "fee": "ì‹œê°„ë‹¹ 800ì›"},
        {"name": "ìš©ë‹´ í•´ì•ˆì£¼ì°¨ì¥", "total": 200, "available": 89, "fee": "ë¬´ë£Œ"}
    ]
    
    return jsonify({
        "updated_at": "2025-11-24T07:50:00Z",
        "parking_lots": parking_lots
    })

@app.route('/api/jeju-si/report-facility', methods=['POST'])
def report_facility():
    data = request.json
    
    report = {
        "report_id": "JS-FAC-2025-112400001",
        "status": "ì ‘ìˆ˜ì™„ë£Œ",
        "type": data.get('type', 'ë„ë¡œ'),
        "location": data.get('location', ''),
        "description": data.get('description', ''),
        "submitted_at": "2025-11-24T07:50:00Z",
        "expected_response": "48ì‹œê°„ ì´ë‚´ í˜„ì¥ í™•ì¸ ì˜ˆì •",
        "tracking_link": "https://jeju.go.kr/report/JS-FAC-2025-112400001"
    }
    
    return jsonify({"report": report})

@app.route('/api/jeju-si/local-events', methods=['GET'])
def local_events():
    events = [
        {"name": "ì œì£¼ ê²¨ìš¸ ë°”ë‹¤ ì¶•ì œ", "date": "2025-12-01", "location": "ì´í˜¸í…Œìš° í•´ë³€", "free": True},
        {"name": "í•œë¼ì‚° ëˆˆê½ƒ íŠ¸ë ˆí‚¹", "date": "2025-12-15", "location": "í•œë¼ì‚°", "free": False},
        {"name": "ì œì£¼ ì•¼ì‹œì¥", "date": "ë§¤ì£¼ ê¸ˆ-ì¼", "location": "ë™ë¬¸ì‹œì¥", "free": True}
    ]
    
    return jsonify({"events": events})

if __name__ == '__main__':
    logger.info("ğŸš€ ì œì£¼ì‹œì²­ AI í–‰ì • ì‹œìŠ¤í…œ ë°±ì—”ë“œ ì‹œì‘ (í¬íŠ¸ 5009)")
    app.run(host='0.0.0.0', port=5009, debug=False)
