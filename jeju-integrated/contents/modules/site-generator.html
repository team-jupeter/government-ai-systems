<!-- AI ì‚¬ì´íŠ¸ ìƒì„±ê¸° - URL ë§í¬ ì§€ì› -->

<style>
.gen-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border: 2px solid #E5E7EB;
    display: flex;
    flex-direction: column;
    height: 600px;
}

.gen-header {
    background: #0B4DA2;
    color: white;
    padding: 1rem;
    font-weight: 700;
    font-size: 16px;
}

.gen-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #F9FAFB;
}

.gen-message {
    margin-bottom: 1rem;
}

.gen-message.ai {
    text-align: left;
}

.gen-message.user {
    text-align: right;
}

.gen-bubble {
    display: inline-block;
    max-width: 80%;
    padding: 0.75rem 1rem;
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
    border-radius: 12px;
}

.gen-bubble.ai {
    background: white;
    border: 2px solid #E5E7EB;
    text-align: left;
}

.gen-bubble.user {
    background: #0B4DA2;
    color: white;
    text-align: left;
}

.gen-bubble.thinking {
    background: #FEF3C7;
    border: 2px solid #FCD34D;
    font-style: italic;
    color: #92400E;
}

.info-collected {
    background: #DBEAFE;
    border: 2px solid #3B82F6;
    padding: 0.75rem;
    margin: 0.5rem 0;
    font-size: 13px;
    line-height: 1.5;
    border-radius: 8px;
}

.gen-input-area {
    padding: 1rem;
    border-top: 2px solid #E5E7EB;
    background: white;
}

.gen-input-row {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

.gen-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
    resize: none;
    font-family: inherit;
}

.gen-input:focus {
    outline: none;
    border-color: #0B4DA2;
}

.gen-send-btn {
    background: #0B4DA2;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
}

.gen-send-btn:hover {
    background: #003876;
}

.file-upload-area {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.file-upload-btn {
    background: #F3F4F6;
    border: 2px solid #D1D5DB;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.file-upload-btn:hover {
    background: #E5E7EB;
    border-color: #9CA3AF;
}

.file-preview-area {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.file-preview-item {
    position: relative;
    width: 80px;
    height: 80px;
    border: 2px solid #E5E7EB;
    border-radius: 6px;
    overflow: hidden;
}

.file-preview-item img,
.file-preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.file-preview-remove {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #DC2626;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    line-height: 1;
}

.file-preview-remove:hover {
    background: #991B1B;
}

.file-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: #F3F4F6;
    font-size: 24px;
}

.url-badge {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 20px;
}
</style>

<div class="gen-container">
    <div class="gen-header">
        ğŸ¤– AI ì‚¬ì´íŠ¸ ìƒì„± ìƒë‹´
    </div>
    
    <div class="gen-chat-messages" id="genChatMessages"></div>
    
    <div class="gen-input-area">
        <div class="gen-input-row">
            <textarea 
                class="gen-input" 
                id="genChatInput" 
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                rows="2"></textarea>
            <button class="gen-send-btn" id="genSendBtn">ì „ì†¡</button>
        </div>
        
        <div class="file-upload-area">
            <button class="file-upload-btn" id="imageBtn">ğŸ“· ì‚¬ì§„</button>
            <button class="file-upload-btn" id="videoBtn">ğŸ¥ ë™ì˜ìƒ</button>
            <button class="file-upload-btn" id="audioBtn">ğŸµ ì˜¤ë””ì˜¤</button>
            
            <!-- Hidden file inputs -->
            <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;">
            <input type="file" id="videoUpload" accept="video/*" style="display:none;">
            <input type="file" id="audioUpload" accept="audio/*" style="display:none;">
        </div>
        
        <div class="file-preview-area" id="filePreviewArea"></div>
    </div>
</div>

<script>
(function() {
    console.log('ğŸš€ í†µí•© ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
    
// ============================================
// JSON Parser
// ============================================
window.GeneratorJSONParser = {
    extractAndParse: function(aiMessage, siteData) {
        try {
            const patterns = [
                /JSON_DATA:\s*(\{[\s\S]*?\})\s*$/m,
                /JSON_DATA:\s*(\{[^{}]*\{[^{}]*\}[^{}]*\})/,
                /JSON_DATA:\s*(\{[^{}]+\})/
            ];
            
            let jsonStr = null;
            for (const pattern of patterns) {
                const match = aiMessage.match(pattern);
                if (match && match[1]) {
                    jsonStr = match[1];
                    break;
                }
            }
            
            if (!jsonStr) {
                console.log('JSON_DATA ì—†ìŒ');
                return null;
            }
            
            console.log('ğŸ“ ì›ë³¸ JSON:', jsonStr);
            
            // 1ì°¨ ì‹œë„: ì›ë³¸ ê·¸ëŒ€ë¡œ
            try {
                const parsedData = JSON.parse(jsonStr);
                console.log('âœ… 1ì°¨ íŒŒì‹± ì„±ê³µ (ì›ë³¸)');
                
                const normalizedData = {};
                Object.entries(parsedData).forEach(([key, value]) => {
                    const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                    normalizedData[camelKey] = value;
                });
                
                Object.assign(siteData, normalizedData);
                return normalizedData;
                
            } catch (e1) {
                console.log('âš ï¸ 1ì°¨ íŒŒì‹± ì‹¤íŒ¨, 2ì°¨ ì‹œë„...');
                
                try {
                    const normalized = this.normalizeJSON(jsonStr);
                    console.log('ğŸ“ ì •ê·œí™”ëœ JSON:', normalized);
                    
                    const parsedData = JSON.parse(normalized);
                    console.log('âœ… 2ì°¨ íŒŒì‹± ì„±ê³µ (ì •ê·œí™”)');
                    
                    const normalizedData = {};
                    Object.entries(parsedData).forEach(([key, value]) => {
                        const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                        normalizedData[camelKey] = value;
                    });
                    
                    Object.assign(siteData, normalizedData);
                    return normalizedData;
                    
                } catch (e2) {
                    console.log('âš ï¸ 2ì°¨ íŒŒì‹± ì‹¤íŒ¨, 3ì°¨ ì‹œë„ (ìˆ˜ë™ íŒŒì‹±)...');
                    return this.manualParse(aiMessage, siteData);
                }
            }
            
        } catch (error) {
            console.error('âŒ ëª¨ë“  íŒŒì‹± ì‹¤íŒ¨:', error);
            return null;
        }
    },
    
    normalizeJSON: function(jsonStr) {
        return jsonStr
            .replace(/'/g, '"')
            .replace(/(\w+):/g, '"$1":')
            .replace(/,\s*}/g, '}')
            .replace(/,\s*]/g, ']')
            .replace(/"\s*:\s*"([^"]*)"(?=[,}])/g, '":"$1"')
            .trim();
    },
    
    manualParse: function(aiMessage, siteData) {
        try {
            const pairs = aiMessage.match(/"(\w+)"\s*:\s*"([^"]*)"/g);
            if (!pairs) return null;
            
            const result = {};
            pairs.forEach(pair => {
                const [key, value] = pair.split(':').map(s => s.trim().replace(/"/g, ''));
                if (key && value) {
                    result[key] = value;
                }
            });
            
            // í‚¤ ë³€í™˜
            const normalizedResult = {};
            Object.entries(result).forEach(([key, value]) => {
                const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                normalizedResult[camelKey] = value;
            });
            Object.assign(siteData, normalizedResult);
            console.log('âœ… í‚¤ ë³€í™˜ ì™„ë£Œ:', normalizedResult);
            
            console.log('âœ… ìˆ˜ë™ íŒŒì‹± ì„±ê³µ:', result);
            return result;
            
        } catch (error) {
            console.error('âŒ ìˆ˜ë™ íŒŒì‹±ë„ ì‹¤íŒ¨:', error);
            return null;
        }
    },
    
    removeJSON: function(text) {
        return text
            .replace(/JSON_DATA:\s*\{[\s\S]*?\}\s*$/m, '')
            .replace(/JSON_DATA:\s*\{[^{}]*\{[^{}]*\}[^{}]*\}/g, '')
            .replace(/JSON_DATA:\s*\{[^{}]+\}/g, '')
            .trim();
    }
};

// ============================================
// Prompts
// ============================================
window.GeneratorPrompts = {
    structures: {
        food: {
            name: 'ìŒì‹ì ',
            sections: ['hero', 'menu', 'facilities', 'chef', 'gallery', 'hours', 'reservations', 'contact'],
            questions: [
                'ëŒ€í‘œ ë©”ë‰´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?',
                'ë©”ë‰´ë¥¼ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì•Œë ¤ì£¼ì„¸ìš”',
                'ê° ë©”ë‰´ì˜ ê°€ê²©ì€?',
                'ì£¼ì°¨ ê°€ëŠ¥ ëŒ€ìˆ˜ëŠ”?',
                'ì˜ˆì•½ í•„ìˆ˜ì¸ê°€ìš”?',
                'ì£¼ìš” ê³ ê° ë¦¬ë·°ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”'
            ]
        },
        government: {
            name: 'ê´€ê³µì„œ',
            sections: ['hero', 'departments', 'services', 'documents', 'hours', 'contact', 'faq'],
            questions: [
                'ë¶€ì„œì˜ ì£¼ìš” ì—…ë¬´ëŠ”?',
                'ì œê³µí•˜ëŠ” ë¯¼ì› ì„œë¹„ìŠ¤ëŠ”?',
                'ê° ì„œë¹„ìŠ¤ì˜ ì²˜ë¦¬ ì‹œê°„ì€?',
                'í•„ìš”í•œ ì„œë¥˜ëŠ”?',
                'ì˜¨ë¼ì¸ ì‹ ì²­ ê°€ëŠ¥í•œê°€ìš”?'
            ]
        },
        medical: {
            name: 'ì˜ë£Œê¸°ê´€',
            sections: ['hero', 'specialties', 'doctors', 'services', 'facilities', 'insurance', 'hours', 'appointments'],
            questions: [
                'ì „ë¬¸ ì§„ë£Œ ê³¼ëª©ì€?',
                'ì˜ë£Œì§„ êµ¬ì„±ì€?',
                'ì£¼ìš” ì§„ë£Œ ì„œë¹„ìŠ¤ëŠ”?',
                'ë³´ìœ  ì˜ë£Œ ì¥ë¹„ëŠ”?',
                'ì˜ˆì•½ì€ ì–´ë–»ê²Œ?'
            ]
        },
        retail: {
            name: 'ì†Œë§¤ì—…',
            sections: ['hero', 'products', 'brands', 'delivery', 'payment', 'gallery', 'hours', 'returns'],
            questions: [
                'ì£¼ë ¥ ìƒí’ˆ ì¹´í…Œê³ ë¦¬ëŠ”?',
                'ê° ì¹´í…Œê³ ë¦¬ë³„ ëŒ€í‘œ ìƒí’ˆì€?',
                'ìƒí’ˆë³„ ê°€ê²©ëŒ€ëŠ”?',
                'ë°°ì†¡ ë°©ë²•ê³¼ ê¸°ê°„ì€?',
                'ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìƒí’ˆì€?'
            ]
        }
    },
    
    getSystemPrompt: function(siteData) {
        const collected = Object.entries(siteData)
            .filter(([k, v]) => v !== null && v !== '')
            .map(([k, v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
            .join(', ');
        
        const structure = siteData.industry ? this.structures[siteData.industry] : null;
        
        let prompt = `ë‹¹ì‹ ì€ ì •ë¶€ í‘œì¤€ ì›¹ì‚¬ì´íŠ¸ ìƒì„± AIì…ë‹ˆë‹¤.

ã€ ì¤‘ìš” ê·œì¹™ ã€‘
1. ì •ë³´ë¥¼ íŒŒì•…í•˜ë©´ ë°˜ë“œì‹œ JSON_DATA í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”
2. JSONì€ ë°˜ë“œì‹œ í•œ ì¤„ë¡œ ì‘ì„±í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆ ê¸ˆì§€)
3. JSON í˜•ì‹: JSON_DATA: {"key": "value"}
4. ë°°ì—´ì€ í”¼í•˜ê³  ë‹¨ìˆœ í‚¤-ê°’ìœ¼ë¡œë§Œ ì €ì¥í•˜ì„¸ìš”

ì˜ˆì‹œ:
ì‚¬ìš©ì: "ë‹¤ì‚¬ë‘ íšŸì§‘ì´ê³  ì „í™”ë²ˆí˜¸ëŠ” 064-123-4567ì…ë‹ˆë‹¤"
AI: ì¢‹ìŠµë‹ˆë‹¤! JSON_DATA: {"business_name": "ë‹¤ì‚¬ë‘ íšŸì§‘", "phone": "064-123-4567"}
`;

        if (!siteData.industry) {
            prompt += `
ã€ 1ë‹¨ê³„: ì—…ì¢… íŒŒì•… ã€‘
ì§ˆë¬¸: "ì–´ë–¤ ì—…ì¢…ì´ì‹ ê°€ìš”? (ìŒì‹ì /ê´€ê³µì„œ/ì˜ë£Œ/ì†Œë§¤)"
`;
        } else {
            prompt += `
ã€ í˜„ì¬ ì—…ì¢…: ${structure.name} ã€‘
ã€ í•„ìš”í•œ ì •ë³´ ã€‘
${structure.questions.map((q, i) => `${i + 1}. ${q}`).join('\n')}

í•œ ë²ˆì— 2-3ê°œì”© ìì—°ìŠ¤ëŸ½ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”.
`;
        }

        prompt += `
ã€ ìˆ˜ì§‘ëœ ì •ë³´ ã€‘
${collected || 'ì—†ìŒ'}

ã€ JSON ì˜ˆì‹œ ã€‘
JSON_DATA: {"menu": "ê´‘ì–´íšŒ, ìš°ëŸ­íšŒ", "price": "30000"}
`;

        return prompt;
    }
};

// ============================================
// File Upload
// ============================================
window.GeneratorFileUpload = {
    uploadedFiles: [],
    
    handleUpload: async function(event, type) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        
        for (let file of files) {
            const maxSize = type === 'image' ? 5 : type === 'video' ? 50 : 10;
            if (file.size > maxSize * 1024 * 1024) {
                alert(`${file.name}: íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ ${maxSize}MB)`);
                continue;
            }
            
            try {
                const base64 = await this.fileToBase64(file);
                const fileData = {
                    type: type,
                    name: file.name,
                    mimeType: file.type,
                    data: base64,
                    uploadedAt: new Date().toISOString()
                };
                
                this.uploadedFiles.push(fileData);
                this.addPreview(fileData, this.uploadedFiles.length - 1);
                
                window.GeneratorCore.addMessage(`ğŸ“ ${file.name} ì—…ë¡œë“œ ì™„ë£Œ`, 'ai');
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨`);
            }
        }
        
        event.target.value = '';
    },
    
    fileToBase64: function(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    addPreview: function(fileData, index) {
        const container = document.getElementById('filePreviewArea');
        const div = document.createElement('div');
        div.className = 'file-preview-item';
        div.dataset.index = index;
        
        let content = '';
        
        if (fileData.isUrl) {
            // URL ë§í¬ì¸ ê²½ìš°
            if (fileData.type === 'image') {
                content = `<img src="${fileData.url}" alt="${fileData.name}">`;
            } else if (fileData.type === 'video') {
                if (fileData.mimeType === 'video/youtube') {
                    const videoId = extractYouTubeId(fileData.url);
                    const thumbnail = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                    content = `<img src="${thumbnail}" alt="YouTube"><div class="url-badge">â–¶ï¸</div>`;
                } else {
                    content = '<div class="file-icon">ğŸ¬<br><small>URL</small></div>';
                }
            } else if (fileData.type === 'audio') {
                content = '<div class="file-icon">ğŸµ<br><small>URL</small></div>';
            }
        } else {
            // Base64 íŒŒì¼ì¸ ê²½ìš°
            if (fileData.type === 'image') {
                content = `<img src="${fileData.data}" alt="${fileData.name}">`;
            } else if (fileData.type === 'video') {
                content = `<video src="${fileData.data}"></video>`;
            } else if (fileData.type === 'audio') {
                content = `<div class="file-icon">ğŸµ</div>`;
            }
        }
        
        div.innerHTML = `
            ${content}
            <button class="file-preview-remove" onclick="removeFile(${index})">Ã—</button>
        `;
        
        container.appendChild(div);
    },
    
    removeFile: function(index) {
        this.uploadedFiles.splice(index, 1);
        
        const container = document.getElementById('filePreviewArea');
        container.innerHTML = '';
        this.uploadedFiles.forEach((file, i) => {
            this.addPreview(file, i);
        });
    }
};

window.handleFileUpload = function(event, type) {
    window.GeneratorFileUpload.handleUpload(event, type);
};

window.removeFile = function(index) {
    window.GeneratorFileUpload.removeFile(index);
};

// ë¯¸ë””ì–´ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (ë¡œì»¬/URL ì„ íƒ)
window.handleMediaButton = function(type) {
    const typeLabels = {
        'image': 'ì‚¬ì§„',
        'video': 'ë™ì˜ìƒ',
        'audio': 'ì˜¤ë””ì˜¤'
    };
    const label = typeLabels[type];
    
    const choice = confirm(`${label} ì¶”ê°€ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:\n\ní™•ì¸ = ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ\nì·¨ì†Œ = ì›¹ ì£¼ì†Œ (URL) ì…ë ¥`);
    
    if (choice) {
        document.getElementById(type + 'Upload').click();
    } else {
        const url = prompt(`${label} URLì„ ì…ë ¥í•˜ì„¸ìš”:\n\nì˜ˆì‹œ:\n- YouTube: https://youtube.com/watch?v=...\n- ì´ë¯¸ì§€: https://example.com/image.jpg`);
        
        if (url && url.trim()) {
            addUrlLink(type, url.trim());
        }
    }
};

// URL ë§í¬ ì¶”ê°€
function addUrlLink(type, url) {
    try {
        new URL(url);
    } catch (e) {
        alert('ì˜¬ë°”ë¥¸ URLì´ ì•„ë‹™ë‹ˆë‹¤.');
        return;
    }
    
    const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
    const typeLabels = { 'image': 'ì‚¬ì§„', 'video': 'ë™ì˜ìƒ', 'audio': 'ì˜¤ë””ì˜¤' };
    
    const linkData = {
        type: type,
        name: url.split('/').pop() || 'url-link',
        mimeType: isYouTube ? 'video/youtube' : `${type}/url`,
        url: url,
        isUrl: true,
        uploadedAt: new Date().toISOString()
    };
    
    window.GeneratorFileUpload.uploadedFiles.push(linkData);
    window.GeneratorFileUpload.addPreview(linkData, window.GeneratorFileUpload.uploadedFiles.length - 1);
    
    window.GeneratorCore.addMessage(`ğŸ”— ${typeLabels[type]} URL ì¶”ê°€: ${url}`, 'ai');
}

// YouTube ID ì¶”ì¶œ
window.extractYouTubeId = function(url) {
    const patterns = [
        /youtube\.com\/watch\?v=([^&]+)/,
        /youtu\.be\/([^?]+)/,
        /youtube\.com\/embed\/([^?]+)/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    return '';
}

// ============================================
// Core
// ============================================
window.GeneratorCore = {
    siteData: {},
    conversationHistory: [],
    
    init: function() {
        this.siteData = {};
        this.conversationHistory = [];
        this.addMessage('ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br><br>ì €ëŠ” ì •ë¶€ í‘œì¤€ ì›¹ì‚¬ì´íŠ¸ ìƒì„±ì„ ë„ì™€ë“œë¦¬ëŠ” AIì…ë‹ˆë‹¤.<br><br>ì–´ë–¤ ì—…ì¢…ì´ì‹ ê°€ìš”? (ìŒì‹ì , ê´€ê³µì„œ, ì˜ë£Œ, ì†Œë§¤, ì„œë¹„ìŠ¤ ë“±)', 'ai');
    },
    
    addMessage: function(text, sender) {
        const container = document.getElementById('genChatMessages');
        const div = document.createElement('div');
        div.className = `gen-message ${sender}`;
        
        let displayText = window.GeneratorJSONParser.removeJSON(text);
        displayText = displayText.replace(/\n/g, '<br>');
        
        div.innerHTML = `<div class="gen-bubble ${sender}">${displayText}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        
        return div;
    },
    
    addThinking: function() {
        const id = 'thinking-' + Date.now();
        const container = document.getElementById('genChatMessages');
        const div = document.createElement('div');
        div.className = 'gen-message ai';
        div.id = id;
        div.innerHTML = '<div class="gen-bubble thinking">ğŸ¤” ìƒê°í•˜ëŠ” ì¤‘...</div>';
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    },
    
    removeMessage: function(id) {
        const element = document.getElementById(id);
        if (element) element.remove();
    },
    
    sendMessage: async function() {
        const input = document.getElementById('genChatInput');
        const message = input.value.trim();
        if (!message) return;
        
        this.addMessage(message, 'user');
        input.value = '';
        
        this.conversationHistory.push({
            role: 'user',
            content: message
        });
        
        const thinkingId = this.addThinking();
        
        try {
            const aiMessage = await this.getAIResponse();
            this.removeMessage(thinkingId);
            
            this.addMessage(aiMessage, 'ai');
            
            this.conversationHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            
            const extracted = window.GeneratorJSONParser.extractAndParse(aiMessage, this.siteData);
            
            // ìë™ í•„ë“œ ë§¤í•‘
            if (this.siteData.businessType && !this.siteData.industry) {
                const typeToIndustry = {
                    'ìŒì‹ì ': 'food',
                    'ê´€ê³µì„œ': 'government',
                    'ì˜ë£Œ': 'medical',
                    'ì˜ë£Œê¸°ê´€': 'medical',
                    'ì†Œë§¤': 'retail',
                    'ì†Œë§¤ì—…': 'retail',
                    'ì„œë¹„ìŠ¤': 'service',
                    'ì„œë¹„ìŠ¤ì—…': 'service',
                    'êµìœ¡': 'education'
                };
                this.siteData.industry = typeToIndustry[this.siteData.businessType] || 'other';
                console.log('âœ… industry ìë™ ë³€í™˜:', this.siteData.industry);
            }
            
            // description ìë™ ìƒì„±
            if (!this.siteData.description && this.siteData.businessName) {
                this.siteData.description = `${this.siteData.businessName}ì…ë‹ˆë‹¤.`;
                console.log('âœ… description ìë™ ìƒì„±:', this.siteData.description);
            }
            
            if (extracted) {
                this.showCollectedInfo();
            }
            
            if (this.checkCompletion()) {
                setTimeout(() => this.completeSite(), 1000);
            }
            
        } catch (error) {
            console.error('AI ì˜¤ë¥˜:', error);
            this.removeMessage(thinkingId);
            this.addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
        }
    },
    
    getAIResponse: async function() {
        const response = await fetch('http://100.30.14.224:3001', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                    {
                        role: 'system',
                        content: window.GeneratorPrompts.getSystemPrompt(this.siteData)
                    },
                    ...this.conversationHistory
                ],
                temperature: 0.7,
                max_tokens: 2000
            })
        });
        
        if (!response.ok) {
            throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
    },
    
    checkCompletion: function() {
        const required = ['businessType', 'businessName', 'phone', 'email', 'address', 'industry', 'description'];
        return required.every(field => this.siteData[field]);
    },
    
    showCollectedInfo: function() {
        const info = [];
        if (this.siteData.businessName) info.push(`ìƒí˜¸: ${this.siteData.businessName}`);
        if (this.siteData.phone) info.push(`ì „í™”: ${this.siteData.phone}`);
        if (this.siteData.address) info.push(`ì£¼ì†Œ: ${this.siteData.address}`);
        
        if (info.length > 0) {
            const existing = document.querySelector('.info-collected');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.className = 'info-collected';
            div.innerHTML = '<strong>ğŸ“ ìˆ˜ì§‘ëœ ì •ë³´:</strong><br>' + info.join(' | ');
            
            const container = document.getElementById('genChatMessages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    },
    
    completeSite: function() {
        const finalData = {
            ...this.siteData,
            id: Date.now().toString(),
            createdAt: new Date().toISOString(),
            gallery: window.GeneratorFileUpload.uploadedFiles
        };
        
        const sites = JSON.parse(localStorage.getItem('aiSites') || '[]');
        sites.push(finalData);
        localStorage.setItem('aiSites', JSON.stringify(sites));
        
        this.addMessage(
            `ğŸ‰ ì™„ë£Œ!<br><br><strong>${this.siteData.businessName}</strong> ì‚¬ì´íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br><br>ìƒˆ íƒ­ì—ì„œ í”„ë¦¬ë·°ê°€ ì—´ë¦½ë‹ˆë‹¤...`,
            'ai'
        );
        
        // ìƒˆ íƒ­ì—ì„œ í”„ë¦¬ë·° ì—´ê¸°
        setTimeout(() => {
            const previewUrl = `/jeju-integrated/site-preview-standalone.html?siteId=${finalData.id}`;
            const newWindow = window.open(previewUrl, '_blank');
            
            if (!newWindow) {
                // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš°
                this.addMessage(
                    `âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í”„ë¦¬ë·°ë¥¼ ì—´ì–´ì£¼ì„¸ìš”:<br><br>` +
                    `<button onclick="window.open('/jeju-integrated/site-preview-standalone.html?siteId=${finalData.id}', '_blank')" ` +
                    `class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ğŸ”— í”„ë¦¬ë·° ì—´ê¸°</button>`,
                    'ai'
                );
            }
        }, 1000);
        
        // ëŒ€í™” ì´ˆê¸°í™”
        this.siteData = {};
        this.conversationHistory = [];
    }
};

    // ============================================
    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // ============================================
    const input = document.getElementById('genChatInput');
    const sendBtn = document.getElementById('genSendBtn');
    const imageUpload = document.getElementById('imageUpload');
    const videoUpload = document.getElementById('videoUpload');
    const audioUpload = document.getElementById('audioUpload');
    const imageBtn = document.getElementById('imageBtn');
    const videoBtn = document.getElementById('videoBtn');
    const audioBtn = document.getElementById('audioBtn');
    
    if (sendBtn) {
        sendBtn.addEventListener('click', () => window.GeneratorCore.sendMessage());
    }
    
    if (input) {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.GeneratorCore.sendMessage();
            }
        });
    }
    
    if (imageUpload) {
        imageUpload.addEventListener('change', (e) => window.GeneratorFileUpload.handleUpload(e, 'image'));
    }
    
    if (videoUpload) {
        videoUpload.addEventListener('change', (e) => window.GeneratorFileUpload.handleUpload(e, 'video'));
    }
    
    if (audioUpload) {
        audioUpload.addEventListener('change', (e) => window.GeneratorFileUpload.handleUpload(e, 'audio'));
    }
    
    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë¡œì»¬/URL ì„ íƒ)
    if (imageBtn) {
        imageBtn.addEventListener('click', () => handleMediaButton('image'));
    }
    
    if (videoBtn) {
        videoBtn.addEventListener('click', () => handleMediaButton('video'));
    }
    
    if (audioBtn) {
        audioBtn.addEventListener('click', () => handleMediaButton('audio'));
    }
    
    console.log('âœ… ëª¨ë“  ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
    window.GeneratorCore.init();
})();
</script>
