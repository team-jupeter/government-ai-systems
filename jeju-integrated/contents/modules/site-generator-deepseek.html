<style>
    .chat-generator {
        background: white;
        border: 2px solid #E5E7EB;
        margin: 2rem 0;
        display: flex;
        flex-direction: column;
        height: 600px;
    }
    
    .chat-gen-header {
        background: #0B4DA2;
        color: white;
        padding: 1.5rem;
        border-bottom: 2px solid #003876;
    }
    
    .chat-gen-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 20px;
        font-weight: 700;
    }
    
    .chat-gen-header p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
    }
    
    .chat-gen-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #F9FAFB;
    }
    
    .chat-gen-message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-gen-message.ai {
        text-align: left;
    }
    
    .chat-gen-message.user {
        text-align: right;
    }
    
    .gen-message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 1rem;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .gen-message-bubble.ai {
        background: white;
        border: 2px solid #E5E7EB;
        color: #1F2937;
    }
    
    .gen-message-bubble.user {
        background: #0B4DA2;
        color: white;
    }
    
    .chat-gen-input-area {
        padding: 1.5rem;
        background: white;
        border-top: 2px solid #E5E7EB;
    }
    
    .chat-gen-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #E5E7EB;
        font-size: 14px;
        resize: none;
        margin-bottom: 0.75rem;
    }
    
    .chat-gen-input:focus {
        outline: none;
        border-color: #0B4DA2;
    }
    
    .chat-gen-btn {
        background: #0B4DA2;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
    }
    
    .chat-gen-btn:hover {
        background: #003876;
    }
    
    .chat-gen-btn:disabled {
        background: #9CA3AF;
        cursor: not-allowed;
    }
    
    .info-collected {
        background: #F0FDF4;
        border-left: 4px solid #22C55E;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-size: 13px;
        color: #166534;
    }
    
    .thinking {
        opacity: 0.6;
        font-style: italic;
    }
</style>

<div class="chat-generator">
    <div class="chat-gen-header">
        <h2>ğŸ¤– ì‚¬ì´íŠ¸ ìƒì„± AI (DeepSeek R1 ì—°ë™)</h2>
        <p>ìì—°ì–´ë¡œ í¸í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”</p>
    </div>
    
    <div class="chat-gen-messages" id="genChatMessages">
        <div class="chat-gen-message ai">
            <div class="gen-message-bubble ai">
                ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” DeepSeek R1 ê¸°ë°˜ ì‚¬ì´íŠ¸ ìƒì„± AIì…ë‹ˆë‹¤. ğŸ˜Š<br><br>
                ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©´ì„œ ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.<br>
                í•œ ë²ˆì— ì—¬ëŸ¬ ì •ë³´ë¥¼ ë§ì”€í•˜ì…”ë„ ë©ë‹ˆë‹¤!<br><br>
                ì˜ˆ: "ì‚¬ì—…ìì´ê³ , ë‹¤ì‚¬ë‘ íšŸì§‘ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì œì£¼ì‹œì—ì„œ ì°¸ì¹˜íšŒë¥¼ íŒ”ê³  ìˆì–´ìš”. ì „í™”ëŠ” 064-123-4567ì´ì—ìš”."
            </div>
        </div>
    </div>
    
    <div class="chat-gen-input-area">
        <textarea 
            class="chat-gen-input" 
            id="genChatInput" 
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
            rows="2"
            onkeypress="handleGenKeypress(event)"
        ></textarea>
        <button class="chat-gen-btn" id="genSendBtn" onclick="sendGenMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
(function() {
    // DeepSeek API ì„¤ì •
    const DEEPSEEK_API_KEY = 'sk-17c1624e3b26497fbca6262419b032f5'; // ì—¬ê¸°ì— API í‚¤ ì…ë ¥
    const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
    
    const siteData = {
        businessType: null,
        businessName: null,
        businessNumber: null,
        phone: null,
        email: null,
        address: null,
        industry: null,
        description: null,
        hours: null,
        website: null
    };
    
    let conversationHistory = [];
    let isProcessing = false;
    
    window.handleGenKeypress = function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendGenMessage();
        }
    };
    
    window.sendGenMessage = async function() {
        if (isProcessing) return;
        
        const input = document.getElementById('genChatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        isProcessing = true;
        document.getElementById('genSendBtn').disabled = true;
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        addGenMessage(message, 'user');
        input.value = '';
        
        // AI ì‘ë‹µ ìƒì„±
        await getAIResponse(message);
        
        isProcessing = false;
        document.getElementById('genSendBtn').disabled = false;
    };
    
    async function getAIResponse(userMessage) {
        // ëŒ€í™” ì´ë ¥ì— ì¶”ê°€
        conversationHistory.push({
            role: 'user',
            content: userMessage
        });
        
        // Thinking ë©”ì‹œì§€ í‘œì‹œ
        const thinkingId = addGenMessage('ìƒê°í•˜ëŠ” ì¤‘...', 'ai', 'thinking');
        
        try {
            // DeepSeek API í˜¸ì¶œ
            const response = await fetch(DEEPSEEK_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'deepseek-reasoner',
                    messages: [
                        {
                            role: 'system',
                            content: getSystemPrompt()
                        },
                        ...conversationHistory
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨: ' + response.status);
            }
            
            const data = await response.json();
            const aiMessage = data.choices[0].message.content;
            
            // Thinking ë©”ì‹œì§€ ì œê±°
            removeMessage(thinkingId);
            
            // AI ì‘ë‹µ í‘œì‹œ
            addGenMessage(aiMessage, 'ai');
            
            // ëŒ€í™” ì´ë ¥ì— ì¶”ê°€
            conversationHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            
            // JSON íŒŒì‹± ì‹œë„ (ì •ë³´ ì¶”ì¶œ)
            extractInfoFromResponse(aiMessage);
            
            // ì™„ë£Œ í™•ì¸
            if (checkCompletion()) {
                setTimeout(() => completeSiteGeneration(), 1000);
            }
            
        } catch (error) {
            console.error('DeepSeek API ì˜¤ë¥˜:', error);
            removeMessage(thinkingId);
            addGenMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
        }
    }
    
    function getSystemPrompt() {
        const collectedInfo = Object.entries(siteData)
            .filter(([key, value]) => value !== null)
            .map(([key, value]) => `${key}: ${value}`)
            .join(', ');
        
        return `ë‹¹ì‹ ì€ ì‚¬ì´íŠ¸ ìƒì„± AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìì™€ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©´ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì•¼ í•©ë‹ˆë‹¤:

í•„ìˆ˜ ì •ë³´:
1. businessType (ì‚¬ì—…ì ìœ í˜•: individual/business/corporation)
2. businessName (ìƒí˜¸ëª… ë˜ëŠ” ì„±í•¨)
3. phone (ì „í™”ë²ˆí˜¸)
4. email (ì´ë©”ì¼)
5. address (ì£¼ì†Œ)
6. industry (ì—…ì¢…: food/retail/service/manufacturing/education/medical/finance/transport/other)
7. description (ì œê³µ ìƒí’ˆ/ì„œë¹„ìŠ¤ ì„¤ëª…)

ì„ íƒ ì •ë³´:
8. hours (ì˜ì—…ì‹œê°„)
9. website (ê¸°ì¡´ ì›¹ì‚¬ì´íŠ¸)
10. businessNumber (ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ë˜ëŠ” ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)

í˜„ì¬ ìˆ˜ì§‘ëœ ì •ë³´: ${collectedInfo || 'ì—†ìŒ'}

ê·œì¹™:
1. ìì—°ìŠ¤ëŸ½ê³  ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”
2. ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ì •ë³´ë¥¼ í•œ ë²ˆì— ì œê³µí•˜ë©´ ëª¨ë‘ ì¸ì‹í•˜ì„¸ìš”
3. í•„ìš”í•œ ì •ë³´ë§Œ ì¶”ê°€ë¡œ ë¬¼ì–´ë³´ì„¸ìš”
4. ì •ë³´ë¥¼ íŒŒì•…í–ˆìœ¼ë©´ í™•ì¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì„¸ìš”
5. ëª¨ë“  í•„ìˆ˜ ì •ë³´ê°€ ìˆ˜ì§‘ë˜ë©´ "ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"ë¼ê³  ë§í•˜ì„¸ìš”

ì‘ë‹µ í˜•ì‹:
- ì¼ë°˜ ëŒ€í™”ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ë‹µ
- ì •ë³´ë¥¼ íŒŒì•…í•œ ê²½ìš°, ì‘ë‹µ ëì— JSON í˜•ì‹ìœ¼ë¡œ ì¶”ê°€:
  JSON_DATA: {"field": "value", ...}`;
    }
    
    function extractInfoFromResponse(aiMessage) {
        // JSON ë°ì´í„° ì¶”ì¶œ
        const jsonMatch = aiMessage.match(/JSON_DATA:\s*({[^}]+})/);
        if (jsonMatch) {
            try {
                const extractedData = JSON.parse(jsonMatch[1]);
                Object.assign(siteData, extractedData);
                showCollectedInfo();
            } catch (e) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        }
    }
    
    function checkCompletion() {
        const required = ['businessType', 'businessName', 'phone', 'email', 'address', 'industry', 'description'];
        return required.every(field => siteData[field]);
    }
    
    function showCollectedInfo() {
        const info = [];
        if (siteData.businessType) info.push(`ìœ í˜•: ${getBusinessTypeText(siteData.businessType)}`);
        if (siteData.businessName) info.push(`ìƒí˜¸: ${siteData.businessName}`);
        if (siteData.phone) info.push(`ì „í™”: ${siteData.phone}`);
        if (siteData.email) info.push(`ì´ë©”ì¼: ${siteData.email}`);
        if (siteData.address) info.push(`ì£¼ì†Œ: ${siteData.address}`);
        if (siteData.industry) info.push(`ì—…ì¢…: ${getIndustryText(siteData.industry)}`);
        
        if (info.length > 0) {
            const existingInfo = document.querySelector('.info-collected');
            if (existingInfo) existingInfo.remove();
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info-collected';
            infoDiv.innerHTML = '<strong>ğŸ“ ìˆ˜ì§‘ëœ ì •ë³´:</strong><br>' + info.join(' | ');
            
            const container = document.getElementById('genChatMessages');
            container.appendChild(infoDiv);
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function completeSiteGeneration() {
        const finalData = {
            ...siteData,
            id: Date.now().toString(),
            createdAt: new Date().toISOString()
        };
        
        const sites = JSON.parse(localStorage.getItem('aiSites') || '[]');
        sites.push(finalData);
        localStorage.setItem('aiSites', JSON.stringify(sites));
        
        addGenMessage(
            `ğŸ‰ ì™„ë£Œ!<br><br><strong>${siteData.businessName}</strong> ì‚¬ì´íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ì ì‹œ í›„ í”„ë¦¬ë·°ë¥¼ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤...`,
            'ai'
        );
        
        setTimeout(() => {
            if (window.loadSitePreview) {
                window.loadSitePreview(finalData);
                document.getElementById('previewModule').scrollIntoView({ behavior: 'smooth' });
            }
        }, 2000);
    }
    
    let messageIdCounter = 0;
    function addGenMessage(text, sender, className = '') {
        const container = document.getElementById('genChatMessages');
        const div = document.createElement('div');
        const id = 'msg-' + (++messageIdCounter);
        div.id = id;
        div.className = `chat-gen-message ${sender} ${className}`;
        div.innerHTML = `<div class="gen-message-bubble ${sender}">${text}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }
    
    function removeMessage(id) {
        const msg = document.getElementById(id);
        if (msg) msg.remove();
    }
    
    function getBusinessTypeText(type) {
        return { 'individual': 'ê°œì¸', 'business': 'ì‚¬ì—…ì', 'corporation': 'ë²•ì¸' }[type] || type;
    }
    
    function getIndustryText(industry) {
        const map = { 'food': 'ìŒì‹ì ', 'retail': 'ì†Œë§¤ì—…', 'service': 'ì„œë¹„ìŠ¤ì—…', 'manufacturing': 'ì œì¡°ì—…', 'education': 'êµìœ¡', 'medical': 'ì˜ë£Œ', 'finance': 'ê¸ˆìœµ', 'transport': 'ìš´ìˆ˜', 'other': 'ê¸°íƒ€' };
        return map[industry] || industry;
    }
})();
</script>
