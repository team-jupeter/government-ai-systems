<style>
    .site-preview {
        background: white;
        border: 2px solid #E5E7EB;
        margin: 2rem 0;
        overflow: hidden;
    }
    
    .site-preview-header {
        background: #0B4DA2;
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .site-preview-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
    }
    
    .site-preview-header button {
        background: white;
        color: #0B4DA2;
        border: none;
        padding: 0.5rem 1rem;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .site-content {
        padding: 2rem;
    }
    
    .site-hero {
        text-align: center;
        padding: 3rem 2rem;
        background: #F9FAFB;
        border-bottom: 2px solid #E5E7EB;
    }
    
    .site-hero h1 {
        color: #1F2937;
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .site-hero p {
        color: #6B7280;
        font-size: 14px;
        line-height: 1.8;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .site-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        padding: 2rem;
    }
    
    .info-card {
        border: 2px solid #E5E7EB;
        padding: 1.5rem;
    }
    
    .info-card h3 {
        color: #1F2937;
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .info-card p {
        color: #6B7280;
        font-size: 14px;
        line-height: 1.8;
        margin: 0.5rem 0;
    }
    
    /* AI ìƒë‹´ì°½ (ì¶•ì†Œ) */
    .ai-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .ai-chat-widget.minimized {
        width: 60px;
        height: 60px;
    }
    
    .ai-chat-widget.expanded {
        width: 380px;
        height: 550px;
    }
    
    .chat-toggle-btn {
        width: 60px;
        height: 60px;
        background: #0B4DA2;
        color: white;
        border: none;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(11, 77, 162, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .chat-toggle-btn:hover {
        background: #003876;
        transform: scale(1.05);
    }
    
    .chat-container {
        display: none;
        flex-direction: column;
        height: 100%;
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .chat-container.active {
        display: flex;
    }
    
    .chat-header {
        background: #0B4DA2;
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
    }
    
    .chat-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #F9FAFB;
    }
    
    .chat-message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-message.ai {
        text-align: left;
    }
    
    .chat-message.user {
        text-align: right;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 0.75rem;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .message-bubble.ai {
        background: white;
        border: 2px solid #E5E7EB;
        color: #1F2937;
    }
    
    .message-bubble.user {
        background: #0B4DA2;
        color: white;
    }
    
    .chat-input-area {
        padding: 1rem;
        background: white;
        border-top: 2px solid #E5E7EB;
    }
    
    .chat-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #E5E7EB;
        font-size: 14px;
        resize: none;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #0B4DA2;
    }
</style>

<div class="site-preview" id="sitePreviewContainer">
    <div class="site-preview-header">
        <h2>ğŸŒ ìƒì„±ëœ AI ì‚¬ì´íŠ¸ í”„ë¦¬ë·°</h2>
        <button onclick="closeSitePreview()">ë‹«ê¸°</button>
    </div>
    
    <div class="site-content">
        <div class="site-hero">
            <h1 id="siteName">ì‚¬ì´íŠ¸ ì´ë¦„</h1>
            <p id="siteDescription">ì‚¬ì´íŠ¸ ì„¤ëª…</p>
        </div>
        
        <div class="site-info">
            <div class="info-card">
                <h3>ğŸ“ ìœ„ì¹˜ ì •ë³´</h3>
                <p id="siteAddress">ì£¼ì†Œ</p>
                <p id="sitePhone">ì „í™”ë²ˆí˜¸</p>
                <p id="siteEmail">ì´ë©”ì¼</p>
            </div>
            
            <div class="info-card">
                <h3>ğŸ• ì˜ì—… ì‹œê°„</h3>
                <p id="siteHours">ì˜ì—…ì‹œê°„</p>
            </div>
            
            <div class="info-card">
                <h3>ğŸ¢ ì‚¬ì—…ì ì •ë³´</h3>
                <p id="siteBusinessType">ì‚¬ì—…ì ìœ í˜•</p>
                <p id="siteIndustry">ì—…ì¢…</p>
                <p id="siteBusinessNumber">ì‚¬ì—…ìë²ˆí˜¸</p>
            </div>
        </div>
    </div>
</div>

<!-- AI ìƒë‹´ ìœ„ì ¯ -->
<div class="ai-chat-widget minimized" id="aiChatWidget">
    <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
        ğŸ’¬
    </button>
    
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3 id="chatBusinessName">AI ìƒë‹´</h3>
            <button class="chat-close" onclick="toggleChat()">Ã—</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message ai">
                <div class="message-bubble ai">
                    ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                rows="2"
                onkeypress="handleChatKeypress(event)"
                onfocus="expandChatOnFocus()"
            ></textarea>
        </div>
    </div>
</div>

<script>
let currentSiteData = null;

window.renderSitePreview = function(siteData) {
    currentSiteData = siteData;
    
    document.getElementById('siteName').textContent = siteData.businessName;
    document.getElementById('siteDescription').textContent = siteData.description;
    document.getElementById('siteAddress').textContent = siteData.address;
    document.getElementById('sitePhone').textContent = 'ğŸ“ ' + siteData.phone;
    document.getElementById('siteEmail').textContent = 'ğŸ“§ ' + siteData.email;
    document.getElementById('siteHours').textContent = siteData.hours || 'ì˜ì—…ì‹œê°„ ì •ë³´ ì—†ìŒ';
    document.getElementById('siteBusinessType').textContent = getBusinessTypeText(siteData.businessType);
    document.getElementById('siteIndustry').textContent = getIndustryText(siteData.industry);
    document.getElementById('siteBusinessNumber').textContent = siteData.businessNumber;
    document.getElementById('chatBusinessName').textContent = siteData.businessName + ' AI ìƒë‹´';
    
    // ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="chat-message ai">
            <div class="message-bubble ai">
                ì•ˆë…•í•˜ì„¸ìš”! ${siteData.businessName} AI ìƒë‹´ì›ì…ë‹ˆë‹¤.<br>
                ${siteData.description}<br>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
    `;
};

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage(message, 'user');
    input.value = '';
    
    // AI ì‘ë‹µ ìƒì„±
    setTimeout(() => {
        const response = generateContextualResponse(message);
        addMessage(response, 'ai');
    }, 800);
}

function generateContextualResponse(userMessage) {
    if (!currentSiteData) {
        return 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.';
    }
    
    const msg = userMessage.toLowerCase();
    const siteName = currentSiteData.businessName;
    const industry = currentSiteData.industry;
    
    // ì˜ì—…ì‹œê°„ ë¬¸ì˜
    if (msg.includes('ì˜ì—…') || msg.includes('ì‹œê°„') || msg.includes('ì–¸ì œ') || msg.includes('ëª‡ì‹œ')) {
        return currentSiteData.hours 
            ? `${siteName}ì˜ ì˜ì—…ì‹œê°„ì€ ${currentSiteData.hours}ì…ë‹ˆë‹¤.`
            : 'ì˜ì—…ì‹œê°„ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì „í™”ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.';
    }
    
    // ìœ„ì¹˜/ì£¼ì†Œ ë¬¸ì˜
    if (msg.includes('ìœ„ì¹˜') || msg.includes('ì£¼ì†Œ') || msg.includes('ì–´ë””')) {
        return `${siteName}ì€(ëŠ”) ${currentSiteData.address}ì— ìœ„ì¹˜í•´ ìˆìŠµë‹ˆë‹¤.`;
    }
    
    // ì—°ë½ì²˜ ë¬¸ì˜
    if (msg.includes('ì „í™”') || msg.includes('ì—°ë½') || msg.includes('ë²ˆí˜¸')) {
        return `ì „í™”ë²ˆí˜¸ëŠ” ${currentSiteData.phone}ì´ë©°, ì´ë©”ì¼ì€ ${currentSiteData.email}ì…ë‹ˆë‹¤.`;
    }
    
    // ë©”ë‰´/ìƒí’ˆ/ì„œë¹„ìŠ¤ ë¬¸ì˜
    if (msg.includes('ë©”ë‰´') || msg.includes('ìƒí’ˆ') || msg.includes('ì„œë¹„ìŠ¤') || msg.includes('ë­') || msg.includes('ë¬´ì—‡')) {
        return `${siteName}ì€(ëŠ”) ë‹¤ìŒ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤:\n${currentSiteData.description}`;
    }
    
    // ì˜ˆì•½ ë¬¸ì˜
    if (msg.includes('ì˜ˆì•½') || msg.includes('ë°©ë¬¸')) {
        return `ì˜ˆì•½ì„ ì›í•˜ì‹œë©´ ${currentSiteData.phone}ë¡œ ì „í™”ì£¼ì‹œê±°ë‚˜, ${currentSiteData.email}ë¡œ ì´ë©”ì¼ ì£¼ì„¸ìš”.`;
    }
    
    // ê°€ê²© ë¬¸ì˜
    if (msg.includes('ê°€ê²©') || msg.includes('ë¹„ìš©') || msg.includes('ì–¼ë§ˆ')) {
        return `êµ¬ì²´ì ì¸ ê°€ê²© ì •ë³´ëŠ” ${currentSiteData.phone}ë¡œ ë¬¸ì˜í•´ì£¼ì‹œë©´ ìì„¸íˆ ì•ˆë‚´í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`;
    }
    
    // ì¸ì‚¬
    if (msg.includes('ì•ˆë…•') || msg.includes('í•˜ì´') || msg.includes('í—¬ë¡œ')) {
        return `ì•ˆë…•í•˜ì„¸ìš”! ${siteName}ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`;
    }
    
    // ê°ì‚¬
    if (msg.includes('ê°ì‚¬') || msg.includes('ê³ ë§ˆ')) {
        return `${siteName}ì„(ë¥¼) ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ë” ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”!`;
    }
    
    // ê¸°ë³¸ ì‘ë‹µ
    const responses = [
        `${siteName}ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹  ì ì„ êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”? ì˜ì—…ì‹œê°„, ìœ„ì¹˜, ì„œë¹„ìŠ¤ ë‚´ìš©, ì—°ë½ì²˜ ë“±ì„ ì•ˆë‚´í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
        `ë„¤, ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ${siteName}ì˜ ì–´ë–¤ ì •ë³´ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?`,
        `${siteName}ì€(ëŠ”) ${getIndustryText(industry)} ë¶„ì•¼ ì‚¬ì—…ì²´ì…ë‹ˆë‹¤. êµ¬ì²´ì ìœ¼ë¡œ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
}

let currentSiteData = null;
let chatHistory = [];
const DEEPSEEK_API_KEY = 'sk-17c1624e3b26497fbca6262419b032f5';

window.renderSitePreview = function(siteData) {
    currentSiteData = siteData;
    chatHistory = [];
    
    document.getElementById('siteName').textContent = siteData.businessName;
    document.getElementById('siteDescription').textContent = siteData.description;
    document.getElementById('siteAddress').textContent = siteData.address;
    document.getElementById('sitePhone').textContent = 'ğŸ“ ' + siteData.phone;
    document.getElementById('siteEmail').textContent = 'ğŸ“§ ' + siteData.email;
    document.getElementById('siteHours').textContent = siteData.hours || 'ì˜ì—…ì‹œê°„ ì •ë³´ ì—†ìŒ';
    document.getElementById('siteBusinessType').textContent = getBusinessTypeText(siteData.businessType);
    document.getElementById('siteIndustry').textContent = getIndustryText(siteData.industry);
    document.getElementById('siteBusinessNumber').textContent = siteData.businessNumber || 'ì •ë³´ ì—†ìŒ';
    document.getElementById('chatBusinessName').textContent = siteData.businessName + ' AI ìƒë‹´';
    
    // ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="chat-message ai">
            <div class="message-bubble ai">
                ì•ˆë…•í•˜ì„¸ìš”! ${siteData.businessName} AI ìƒë‹´ì›ì…ë‹ˆë‹¤.<br>
                ${siteData.description}<br>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
    `;
};

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessage(message, 'user');
    input.value = '';
    
    // ëŒ€í™” ì´ë ¥ì— ì¶”ê°€
    chatHistory.push({ role: 'user', content: message });
    
    // Thinking ë©”ì‹œì§€
    const thinkingId = 'thinking-' + Date.now();
    const messagesContainer = document.getElementById('chatMessages');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = thinkingId;
    thinkingDiv.className = 'chat-message ai';
    thinkingDiv.innerHTML = '<div class="message-bubble ai" style="opacity: 0.6; font-style: italic;">ìƒê°í•˜ëŠ” ì¤‘...</div>';
    messagesContainer.appendChild(thinkingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    try {
        const response = await fetch('http://100.30.14.224:3001', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                    {
                        role: 'system',
                        content: getSiteSystemPrompt()
                    },
                    ...chatHistory
                ],
                temperature: 0.7,
                max_tokens: 1000
            })
        });
        
        if (!response.ok) {
            throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        // Thinking ë©”ì‹œì§€ ì œê±°
        document.getElementById(thinkingId).remove();
        
        // AI ì‘ë‹µ ì¶”ê°€
        addMessage(aiResponse, 'ai');
        
        // ëŒ€í™” ì´ë ¥ì— ì¶”ê°€
        chatHistory.push({ role: 'assistant', content: aiResponse });
        
    } catch (error) {
        console.error('DeepSeek API ì˜¤ë¥˜:', error);
        document.getElementById(thinkingId).remove();
        addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
    }
}

function getSiteSystemPrompt() {
    if (!currentSiteData) return 'ë‹¹ì‹ ì€ ì¹œì ˆí•œ ê³ ê° ìƒë‹´ AIì…ë‹ˆë‹¤.';
    
    return `ë‹¹ì‹ ì€ ${currentSiteData.businessName}ì˜ AI ìƒë‹´ì›ì…ë‹ˆë‹¤.

ì‚¬ì—…ì²´ ì •ë³´:
- ìƒí˜¸ëª…: ${currentSiteData.businessName}
- ì—…ì¢…: ${getIndustryText(currentSiteData.industry)}
- ì£¼ì†Œ: ${currentSiteData.address}
- ì „í™”ë²ˆí˜¸: ${currentSiteData.phone}
- ì´ë©”ì¼: ${currentSiteData.email}
- ì˜ì—…ì‹œê°„: ${currentSiteData.hours || 'ì •ë³´ ì—†ìŒ'}
- ì œê³µ ì„œë¹„ìŠ¤: ${currentSiteData.description}

ì—­í• :
1. ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”
2. ê³ ê°ì˜ ì§ˆë¬¸ì— ì •í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”
3. ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜ì—…ì‹œê°„, ìœ„ì¹˜, ì„œë¹„ìŠ¤ ë“±ì„ ì•ˆë‚´í•˜ì„¸ìš”
4. ì˜ˆì•½ì´ë‚˜ ë¬¸ì˜ëŠ” ì „í™”ë‚˜ ì´ë©”ì¼ë¡œ ì•ˆë‚´í•˜ì„¸ìš”
5. ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”`;
}
})();
</script>
