<style>
    .site-preview-container {
        background: white;
        border: 2px solid #E5E7EB;
        margin: 2rem 0;
    }
    
    .site-header {
        background: #0B4DA2;
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .site-header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
    }
    
    .close-btn {
        background: white;
        color: #0B4DA2;
        border: none;
        padding: 0.5rem 1rem;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .site-content {
        padding: 2rem;
    }
    
    .dynamic-section {
        margin: 2rem 0;
        padding: 1.5rem;
        border: 2px solid #E5E7EB;
    }
    
    .section-title {
        color: #1F2937;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #0B4DA2;
    }
    
    .field-item {
        margin: 0.75rem 0;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .field-label {
        font-weight: 600;
        color: #374151;
        margin-right: 0.5rem;
    }
    
    .field-value {
        color: #1F2937;
    }
    
    .list-items {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .list-item-card {
        background: #F9FAFB;
        padding: 1rem;
        border: 1px solid #E5E7EB;
    }
    
    .ai-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .chat-toggle {
        width: 60px;
        height: 60px;
        background: #0B4DA2;
        color: white;
        border: none;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(11, 77, 162, 0.4);
    }
    
    .chat-container {
        display: none;
        width: 380px;
        height: 550px;
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        flex-direction: column;
    }
    
    .chat-container.active {
        display: flex;
    }
    
    .chat-header {
        background: #0B4DA2;
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #F9FAFB;
    }
    
    .chat-message {
        margin-bottom: 1rem;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 0.75rem;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .message-bubble.ai {
        background: white;
        border: 2px solid #E5E7EB;
    }
    
    .message-bubble.user {
        background: #0B4DA2;
        color: white;
    }
    
    .chat-message.user {
        text-align: right;
    }
    
    .chat-input-area {
        padding: 1rem;
        border-top: 2px solid #E5E7EB;
    }
    
    .chat-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #E5E7EB;
        font-size: 14px;
        resize: none;
    }
</style>

<div class="site-preview-container">
    <div class="site-header">
        <h1 id="previewTitle">ğŸŒ AI ì‚¬ì´íŠ¸ í”„ë¦¬ë·°</h1>
        <button class="close-btn" onclick="closePreview()">ë‹«ê¸°</button>
    </div>
    
    <div class="site-content" id="dynamicContent">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
    </div>
</div>

<div class="ai-chat-widget">
    <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">ğŸ’¬</button>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3 id="chatTitle">AI ìƒë‹´</h3>
            <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer;" onclick="toggleChat()">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="2" onkeypress="handleKeypress(event)"></textarea>
        </div>
    </div>
</div>

<script>
(function() {
    let currentSiteData = null;
    let chatHistory = [];

    // ë°ì´í„° íƒ€ì…ë³„ ë Œë”ë§ í•¨ìˆ˜
    function renderValue(value) {
        if (Array.isArray(value)) {
            return renderArray(value);
        } else if (typeof value === 'object' && value !== null) {
            return renderObject(value);
        } else {
            return `<span class="field-value">${escapeHtml(String(value))}</span>`;
        }
    }

    function renderArray(arr) {
        if (arr.length === 0) return '<span class="field-value">ì •ë³´ ì—†ìŒ</span>';
        
        // ë°°ì—´ ìš”ì†Œê°€ ê°ì²´ì¸ ê²½ìš° (ì˜ˆ: ìƒí’ˆ ëª©ë¡)
        if (typeof arr[0] === 'object') {
            return `<div class="list-items">${arr.map(item => `
                <div class="list-item-card">
                    ${Object.entries(item).map(([k, v]) => `
                        <div class="field-item">
                            <span class="field-label">${k}:</span>
                            ${renderValue(v)}
                        </div>
                    `).join('')}
                </div>
            `).join('')}</div>`;
        }
        
        // ë‹¨ìˆœ ë°°ì—´ (ì˜ˆ: íƒœê·¸)
        return `<span class="field-value">${arr.join(', ')}</span>`;
    }

    function renderObject(obj) {
        return Object.entries(obj).map(([key, value]) => `
            <div class="field-item">
                <span class="field-label">${key}:</span>
                ${renderValue(value)}
            </div>
        `).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
    window.renderSitePreview = function(siteData) {
        currentSiteData = siteData;
        chatHistory = [];
        
        const container = document.getElementById('dynamicContent');
        
        // ê¸°ë³¸ ì •ë³´ (í•­ìƒ í‘œì‹œ)
        const basicInfo = ['businessName', 'description', 'phone', 'email', 'address'];
        const basicSection = basicInfo
            .filter(key => siteData[key])
            .map(key => `
                <div class="field-item">
                    <span class="field-label">${getFieldLabel(key)}:</span>
                    ${renderValue(siteData[key])}
                </div>
            `).join('');
        
        let html = `<div class="dynamic-section">
            <div class="section-title">ê¸°ë³¸ ì •ë³´</div>
            ${basicSection}
        </div>`;
        
        // ë‚˜ë¨¸ì§€ ëª¨ë“  í•„ë“œë¥¼ ë™ì  ì„¹ì…˜ìœ¼ë¡œ
        Object.entries(siteData).forEach(([key, value]) => {
            if (!basicInfo.includes(key) && !['id', 'createdAt'].includes(key)) {
                html += `<div class="dynamic-section">
                    <div class="section-title">${getFieldLabel(key)}</div>
                    ${renderValue(value)}
                </div>`;
            }
        });
        
        container.innerHTML = html;
        
        // ì±„íŒ… ì´ˆê¸°í™”
        document.getElementById('chatTitle').textContent = (siteData.businessName || 'AI') + ' ìƒë‹´';
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="chat-message ai">
                <div class="message-bubble ai">
                    ì•ˆë…•í•˜ì„¸ìš”! ${siteData.businessName || 'ì‚¬ì´íŠ¸'} AI ìƒë‹´ì›ì…ë‹ˆë‹¤.<br>
                    ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                </div>
            </div>
        `;
    };

    function getFieldLabel(key) {
        const labels = {
            businessName: 'ìƒí˜¸ëª…',
            description: 'ì„¤ëª…',
            phone: 'ì „í™”ë²ˆí˜¸',
            email: 'ì´ë©”ì¼',
            address: 'ì£¼ì†Œ',
            hours: 'ì˜ì—…ì‹œê°„',
            industry: 'ì—…ì¢…',
            businessType: 'ì‚¬ì—…ì ìœ í˜•',
            businessNumber: 'ì‚¬ì—…ìë²ˆí˜¸',
            products: 'ìƒí’ˆ',
            services: 'ì„œë¹„ìŠ¤',
            menu: 'ë©”ë‰´',
            reviews: 'ë¦¬ë·°',
            features: 'íŠ¹ì§•'
        };
        return labels[key] || key;
    }

    // ì±„íŒ… í•¨ìˆ˜ë“¤
    window.toggleChat = function() {
        const container = document.getElementById('chatContainer');
        const toggle = document.getElementById('chatToggle');
        
        if (container.classList.contains('active')) {
            container.classList.remove('active');
            toggle.style.display = 'flex';
        } else {
            container.classList.add('active');
            toggle.style.display = 'none';
        }
    };

    window.handleKeypress = function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    };

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        
        addChatMessage(message, 'user');
        input.value = '';
        
        chatHistory.push({ role: 'user', content: message });
        
        try {
            const response = await fetch('http://100.30.14.224:3001', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'system',
                            content: `ë‹¹ì‹ ì€ ${currentSiteData?.businessName || 'ì‚¬ì´íŠ¸'}ì˜ AI ìƒë‹´ì›ì…ë‹ˆë‹¤.\n\nì‚¬ì´íŠ¸ ì •ë³´:\n${JSON.stringify(currentSiteData, null, 2)}\n\nì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”.`
                        },
                        ...chatHistory
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            chatHistory.push({ role: 'assistant', content: aiResponse });
            addChatMessage(aiResponse, 'ai');
            
        } catch (error) {
            console.error('Chat error:', error);
            addChatMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai');
        }
    }

    function addChatMessage(text, sender) {
        const messages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `chat-message ${sender}`;
        div.innerHTML = `<div class="message-bubble ${sender}">${text}</div>`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    window.closePreview = function() {
        document.querySelector('.site-preview-container').style.display = 'none';
        document.querySelector('.ai-chat-widget').style.display = 'none';
    };
})();
</script>
