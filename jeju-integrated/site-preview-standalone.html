<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒì„± ì‚¬ì´íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #F9FAFB;
        }
        
        .site-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .site-header {
            background: linear-gradient(135deg, #0B4DA2, #0066CC);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        
        .site-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .site-subtitle {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .site-content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 3rem;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #0B4DA2;
        }
        
        .field-item {
            margin: 1rem 0;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .field-label {
            font-weight: 600;
            color: #374151;
            margin-right: 0.5rem;
        }
        
        .field-value {
            color: #1F2937;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .card {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 1.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .card:hover {
            border-color: #0B4DA2;
            box-shadow: 0 4px 12px rgba(11, 77, 162, 0.1);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .gallery-item {
            position: relative;
            width: 100%;
            padding-top: 100%;
            overflow: hidden;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
        }
        
        .gallery-item img,
        .gallery-item video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* AI ìƒë‹´ì°½ */
        .ai-helper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .ai-toggle-btn {
            width: 60px;
            height: 60px;
            background: #0B4DA2;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(11, 77, 162, 0.4);
            transition: all 0.2s;
        }
        
        .ai-toggle-btn:hover {
            transform: scale(1.1);
            background: #003876;
        }
        
        .ai-chat-window {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-chat-window.active {
            display: flex;
        }
        
        .ai-chat-header {
            background: #0B4DA2;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #F9FAFB;
        }
        
        .ai-message {
            margin-bottom: 1rem;
        }
        
        .ai-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .ai-message.assistant .ai-bubble {
            background: white;
            border: 2px solid #E5E7EB;
        }
        
        .ai-message.user {
            text-align: right;
        }
        
        .ai-message.user .ai-bubble {
            background: #0B4DA2;
            color: white;
        }
        
        .ai-chat-input-area {
            padding: 1rem;
            border-top: 2px solid #E5E7EB;
        }
        
        .ai-chat-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }
        
        .ai-file-upload {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .ai-file-btn {
            background: #F3F4F6;
            border: 2px solid #D1D5DB;
            padding: 0.5rem;
            font-size: 18px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        /* ìˆ˜ì • ë²„íŠ¼ */
        .edit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10B981;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .edit-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="site-container">
        <div class="site-header">
            <h1 class="site-title" id="siteTitle">AI ìƒì„± ì‚¬ì´íŠ¸</h1>
            <p class="site-subtitle" id="siteSubtitle">ë¡œë”© ì¤‘...</p>
        </div>
        
        <div class="site-content" id="siteContent">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
    </div>
    
    <!-- ìˆ˜ì • ë²„íŠ¼ -->
    <button class="edit-btn" onclick="editSite()">âœï¸ ì‚¬ì´íŠ¸ ìˆ˜ì •</button>
    
    <!-- AI ìƒë‹´ì°½ -->
    <div class="ai-helper">
        <button class="ai-toggle-btn" onclick="toggleAIChat()">?</button>
        
        <div class="ai-chat-window" id="aiChatWindow">
            <div class="ai-chat-header">
                <h3>AI ìƒë‹´ì›</h3>
                <button class="ai-chat-close" onclick="toggleAIChat()">Ã—</button>
            </div>
            
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="ai-message assistant">
                    <div class="ai-bubble">
                        ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                    </div>
                </div>
            </div>
            
            <div class="ai-chat-input-area">
                <textarea 
                    class="ai-chat-input" 
                    id="aiChatInput" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    rows="2"
                    onkeypress="handleAIChatKeypress(event)"></textarea>
                
                <div class="ai-file-upload">
                    <label class="ai-file-btn" title="ì‚¬ì§„ ì—…ë¡œë“œ">
                        ğŸ“·
                        <input type="file" accept="image/*" multiple onchange="handleAIFileUpload(event, 'image')" style="display:none;">
                    </label>
                    <label class="ai-file-btn" title="ë™ì˜ìƒ ì—…ë¡œë“œ">
                        ğŸ¥
                        <input type="file" accept="video/*" onchange="handleAIFileUpload(event, 'video')" style="display:none;">
                    </label>
                    <label class="ai-file-btn" title="ì˜¤ë””ì˜¤ ì—…ë¡œë“œ">
                        ğŸµ
                        <input type="file" accept="audio/*" onchange="handleAIFileUpload(event, 'audio')" style="display:none;">
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    (function() {
        let currentSiteData = null;
        let chatHistory = [];
        let uploadedFiles = [];
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const siteId = params.get('siteId');
            
            if (!siteId) {
                document.getElementById('siteContent').innerHTML = '<p style="text-align:center;padding:2rem;color:#DC2626;">ì‚¬ì´íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            loadSiteData(siteId);
        });
        
        // ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ
        function loadSiteData(siteId) {
            const sites = JSON.parse(localStorage.getItem('aiSites') || '[]');
            const site = sites.find(s => s.id === siteId);
            
            if (!site) {
                document.getElementById('siteContent').innerHTML = '<p style="text-align:center;padding:2rem;color:#DC2626;">ì‚¬ì´íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            currentSiteData = site;
            renderSite(site);
        }
        
        // ì‚¬ì´íŠ¸ ë Œë”ë§
        function renderSite(data) {
            document.getElementById('siteTitle').textContent = data.businessName || 'AI ì‚¬ì´íŠ¸';
            document.getElementById('siteSubtitle').textContent = data.description || '';
            
            const container = document.getElementById('siteContent');
            let html = '';
            
            // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
            const basicFields = ['phone', 'email', 'address', 'hours'];
            const basicInfo = basicFields.filter(f => data[f]).map(f => `
                <div class="field-item">
                    <span class="field-label">${getFieldLabel(f)}:</span>
                    <span class="field-value">${data[f]}</span>
                </div>
            `).join('');
            
            if (basicInfo) {
                html += `<div class="section">
                    <h2 class="section-title">ê¸°ë³¸ ì •ë³´</h2>
                    ${basicInfo}
                </div>`;
            }
            
            // ë‚˜ë¨¸ì§€ í•„ë“œ ë™ì  ë Œë”ë§
            Object.entries(data).forEach(([key, value]) => {
                if (!['id', 'createdAt', 'businessName', 'description', ...basicFields].includes(key)) {
                    html += renderField(key, value);
                }
            });
            
            // ê°¤ëŸ¬ë¦¬
            if (data.gallery && data.gallery.length > 0) {
                html += `<div class="section">
                    <h2 class="section-title">ê°¤ëŸ¬ë¦¬</h2>
                    <div class="gallery-grid">
                        ${data.gallery.map(file => {
                            if (file.type === 'image') {
                                return `<div class="gallery-item"><img src="${file.data}" alt="${file.name}"></div>`;
                            } else if (file.type === 'video') {
                                return `<div class="gallery-item"><video src="${file.data}" controls></video></div>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        // í•„ë“œ ë Œë”ë§
        function renderField(key, value) {
            if (Array.isArray(value)) {
                return renderArray(key, value);
            } else if (typeof value === 'object' && value !== null) {
                return renderObject(key, value);
            } else {
                return `<div class="section">
                    <h2 class="section-title">${getFieldLabel(key)}</h2>
                    <div class="field-value">${escapeHtml(String(value))}</div>
                </div>`;
            }
        }
        
        // ë°°ì—´ ë Œë”ë§
        function renderArray(key, arr) {
            if (arr.length === 0) return '';
            
            if (typeof arr[0] === 'object') {
                const cards = arr.map(item => `
                    <div class="card">
                        ${Object.entries(item).map(([k, v]) => {
                            if (k === 'reviews' && Array.isArray(v)) {
                                return `<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #E5E7EB;">
                                    <strong>ë¦¬ë·°:</strong><br>
                                    ${v.map(r => `â­ ${r.rating || 5}/5 - ${r.comment || ''} (${r.author || 'ìµëª…'})`).join('<br>')}
                                </div>`;
                            }
                            return `<div style="margin:0.5rem 0;">
                                <strong>${k}:</strong> ${escapeHtml(String(v))}
                            </div>`;
                        }).join('')}
                    </div>
                `).join('');
                
                return `<div class="section">
                    <h2 class="section-title">${getFieldLabel(key)}</h2>
                    <div class="card-grid">${cards}</div>
                </div>`;
            } else {
                return `<div class="section">
                    <h2 class="section-title">${getFieldLabel(key)}</h2>
                    <div class="field-value">${arr.join(', ')}</div>
                </div>`;
            }
        }
        
        // ê°ì²´ ë Œë”ë§
        function renderObject(key, obj) {
            const fields = Object.entries(obj).map(([k, v]) => `
                <div class="field-item">
                    <span class="field-label">${k}:</span>
                    <span class="field-value">${escapeHtml(String(v))}</span>
                </div>
            `).join('');
            
            return `<div class="section">
                <h2 class="section-title">${getFieldLabel(key)}</h2>
                ${fields}
            </div>`;
        }
        
        // í•„ë“œ ë¼ë²¨
        function getFieldLabel(key) {
            const labels = {
                phone: 'ì „í™”ë²ˆí˜¸',
                email: 'ì´ë©”ì¼',
                address: 'ì£¼ì†Œ',
                hours: 'ì˜ì—…ì‹œê°„',
                menu: 'ë©”ë‰´',
                services: 'ì„œë¹„ìŠ¤',
                doctors: 'ì˜ë£Œì§„',
                products: 'ìƒí’ˆ',
                facilities: 'ì‹œì„¤',
                reviews: 'ë¦¬ë·°',
                gallery: 'ê°¤ëŸ¬ë¦¬'
            };
            return labels[key] || key;
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // AI ìƒë‹´ì°½ í† ê¸€
        window.toggleAIChat = function() {
            const window = document.getElementById('aiChatWindow');
            window.classList.toggle('active');
        };
        
        // AI ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addAIChatMessage(text, sender) {
            const container = document.getElementById('aiChatMessages');
            const div = document.createElement('div');
            div.className = `ai-message ${sender}`;
            
            const displayText = text.replace(/\n/g, '<br>');
            div.innerHTML = `<div class="ai-bubble">${displayText}</div>`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // AI ì±„íŒ… Enter ì²˜ë¦¬
        window.handleAIChatKeypress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIChatMessage();
            }
        };
        
        // AI ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        window.sendAIChatMessage = async function() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addAIChatMessage(message, 'user');
            input.value = '';
            
            chatHistory.push({ role: 'user', content: message });
            
            try {
                const response = await fetch('http://100.30.14.224:3001', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: `ë‹¹ì‹ ì€ ${currentSiteData?.businessName || 'ì‚¬ì´íŠ¸'}ì˜ AI ìƒë‹´ì›ì…ë‹ˆë‹¤.\n\nì‚¬ì´íŠ¸ ì •ë³´:\n${JSON.stringify(currentSiteData, null, 2)}\n\nì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”.`
                            },
                            ...chatHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                chatHistory.push({ role: 'assistant', content: aiResponse });
                addAIChatMessage(aiResponse, 'assistant');
                
            } catch (error) {
                console.error('AI ì±„íŒ… ì˜¤ë¥˜:', error);
                addAIChatMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'assistant');
            }
        };
        
        // AI ì±„íŒ… íŒŒì¼ ì—…ë¡œë“œ
        window.handleAIFileUpload = async function(event, type) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (let file of files) {
                try {
                    const base64 = await fileToBase64(file);
                    uploadedFiles.push({
                        type: type,
                        name: file.name,
                        data: base64
                    });
                    
                    addAIChatMessage(`ğŸ“ ${file.name} ì—…ë¡œë“œ ì™„ë£Œ`, 'assistant');
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
            
            event.target.value = '';
        };
        
        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // ì‚¬ì´íŠ¸ ìˆ˜ì •
        window.editSite = function() {
            const password = prompt('ì‚¬ì´íŠ¸ ìˆ˜ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            // ê°„ë‹¨í•œ ì¸ì¦ (ì‹¤ì œë¡œëŠ” ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ í•„ìš”)
            if (password === currentSiteData.phone || password === 'admin') {
                alert('ìˆ˜ì • ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìˆ˜ì • ê¸°ëŠ¥ì€ AI ìƒë‹´ì°½ì—ì„œ "ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤"ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.');
                toggleAIChat();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        };
    })();
    </script>
</body>
</html>
