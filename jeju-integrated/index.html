<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œì£¼ AI í¬í„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0066FF;
            --secondary-blue: #0052CC;
            --gray-50: #F9FAFB;
            --gray-700: #374151;
            --gray-800: #1F2937;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--gray-50);
            margin: 0;
            padding: 0;
        }
        .notice-banner {
            background: var(--gray-800);
            border-bottom: 1px solid var(--gray-700);
            padding: 0.375rem 0;
        }
        .gov-banner {
            background: linear-gradient(135deg, #0047B3 0%, #003D99 100%);
            color: white;
            padding: 0.75rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-nav {
            background: white;
            border-bottom: 2px solid #F3F4F6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-button {
            padding: 1rem 2rem;
            text-decoration: none;
            display: inline-block;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        .tab-button:hover {
            color: var(--primary-blue);
            background-color: #E6F0FF;
        }
        .tab-button.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            font-weight: 600;
        }
        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            border: none;
        }
        .btn-white {
            background: white;
            color: var(--gray-800);
            border: 1px solid white;
        }
        .btn-white:hover {
            background: #F3F4F6;
        }
        #content-container {
            min-height: 600px;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6B7280;
        }
    </style>
</head>
<body>
    <!-- ì•ˆë‚´ ë°°ë„ˆ -->
    <!-- ì•ˆë‚´ ë°°ë„ˆ (ì§™ì€ ê²€ì²­ìƒ‰) -->
    <div class="notice-banner">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center gap-2 text-xs text-white">
                <span>âš ï¸</span>
                <span>ë³¸ ì‚¬ì´íŠ¸ëŠ” ì˜¤í”ˆí•´ì‹œ ì‹¤ì¦ ë° í…ŒìŠ¤íŠ¸ìš©ì´ë©°, ì •ë¶€ ê³µì‹ ì‚¬ì´íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤.</span>
            </div>
        </div>
    </div>

    <!-- ì •ë¶€ ê³µì‹ ë°°ë„ˆ (ì²­ìƒ‰) -->
    <header class="gov-banner">
        <div class="max-w-7xl mx-auto px-4">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <!-- ì™¼ìª½: ì˜¤í”ˆí•´ì‹œ, í¬í„¸ ë²„íŠ¼ -->
                <div style="display: flex; gap: 0.5rem;">
                    <a href="http://100.30.14.224/openhash-system/" class="btn btn-white">ì˜¤í”ˆí•´ì‹œ â“</a>
                    <a href="http://100.30.14.224/portal/" class="btn btn-white">êµ­ê°€ í¬í„¸</a>
                </div>
                
                <!-- ì¤‘ì•™: ì œëª© -->
                <h1 class="text-base font-bold" style="flex: 1; text-align: center;">ìš°ë¦¬ ì‚¬íšŒì˜ ëª¨ë“  ê²ƒì„ Openhashì™€ AIë¡œ ì¬êµ¬ì„±í•©ë‹ˆë‹¤.</h1>
                
                <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button onclick="handleAuth()" class="btn btn-white" id="authBtn">ë¡œê·¸ì¸</button>
                    <span id="userInfo" class="text-xs text-white" style="display: none;"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="tab-nav">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-1">
                <button class="tab-button active" data-tab="tab1" onclick="loadTab('tab1')">í¬í„¸</button>
                <button class="tab-button" data-tab="tab8" onclick="loadTab('tab8')">PDV</button>
                <div style="flex: 1;"></div>
                <button class="tab-button" data-tab="tab9" onclick="loadTab('tab9')">ì´ìš© ì•ˆë‚´</button>
                <button class="tab-button" data-tab="tab10" onclick="loadTab('tab10')">How it works</button>
            </div>
        </div>
    </nav>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ë¡œê·¸ì¸</h2>
            <p class="text-sm text-gray-600 mb-4">ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì „í™”ë²ˆí˜¸ê°€ ê·€í•˜ì˜ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.</p>
            <input type="tel" id="phoneInput" placeholder="010-0000-0000" 
                   style="width: 100%; padding: 0.5rem 1rem; border: 1px solid #D1D5DB; border-radius: 4px; margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="doLogin()" style="flex: 1; background: #0066FF; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">
                    í™•ì¸
                </button>
                <button onclick="closeModal()" style="flex: 1; background: #D1D5DB; color: #374151; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer;">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div id="content-container">
        <div class="loading">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <script>
        let currentTab = 'tab1';
        let currentPage = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            checkLoginStatus();
            
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('page-')) {
                const pageName = hash.replace('page-', '');
                loadPage(pageName);
            } else {
                const tabToLoad = hash || 'tab1';
                loadTab(tabToLoad);
            }
        });

        // íƒ­ ë¡œë“œ í•¨ìˆ˜
        async function loadTab(tabName) {
            currentTab = tabName;
            currentPage = '';
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            window.location.hash = tabName;
            
            const container = document.getElementById('content-container');
            container.innerHTML = '<div class="loading">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const response = await fetch(`contents/${tabName}-content.html`);
                if (!response.ok) throw new Error('ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const html = await response.text();
                container.innerHTML = html;
                
                executeScripts(container);
            } catch (error) {
                console.error('Error loading tab:', error);
                container.innerHTML = '<div class="loading" style="color: #DC2626;">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ (ë„ì²­, ì‹œì²­ ë“±)
        async function loadPage(pageName) {
            currentPage = pageName;
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            window.location.hash = 'page-' + pageName;
            
            const container = document.getElementById('content-container');
            container.innerHTML = '<div class="loading">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const response = await fetch(`contents/${pageName}-content.html`);
                if (!response.ok) throw new Error('ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const html = await response.text();
                container.innerHTML = html;
                
                executeScripts(container);
            } catch (error) {
                console.error('Error loading page:', error);
                container.innerHTML = '<div class="loading" style="color: #DC2626;">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í•¨ìˆ˜
        function executeScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                } else {
                    newScript.textContent = script.textContent;
                }
                document.body.appendChild(newScript);
                script.remove();
            });
        }

        // ë¡œê·¸ì¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function checkLoginStatus() {
            const phoneNumber = localStorage.getItem('userPhone');
            const authBtn = document.getElementById('authBtn');
            const userInfo = document.getElementById('userInfo');
            
            if (phoneNumber) {
                authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                userInfo.textContent = phoneNumber;
                userInfo.style.display = 'inline';
            } else {
                authBtn.textContent = 'ë¡œê·¸ì¸';
                userInfo.style.display = 'none';
            }
        }

        function handleAuth() {
            const phoneNumber = localStorage.getItem('userPhone');
            
            if (phoneNumber) {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('userPhone');
                    alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                    checkLoginStatus();
                }
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        function doLogin() {
            const phoneInput = document.getElementById('phoneInput');
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const phoneRegex = /^[0-9-]+$/;
            if (!phoneRegex.test(phoneNumber)) {
                alert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            localStorage.setItem('userPhone', phoneNumber);
            alert('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            closeModal();
            checkLoginStatus();
        }

        function closeModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('phoneInput').value = '';
        }

        document.getElementById('phoneInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doLogin();
            }
        });

        // ì „ì—­ í—¬í¼ í•¨ìˆ˜ë“¤
        window.getUserPhone = function() {
            return localStorage.getItem('userPhone');
        };

        window.requireLogin = function() {
            const phone = getUserPhone();
            if (!phone) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                handleAuth();
                return false;
            }
            return true;
        };

        // ì „ì—­ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        window.navigateToPage = loadPage;
        window.navigateToTab = loadTab;
    </script>
</body>
</html>

    <!-- Floating Help Button -->
    <button id="floatingHelpBtn" class="floating-help-btn" onclick="openFloatingChat()">
        <span class="help-icon">?</span>
    </button>

    <!-- Global Chat Overlay -->
    <div class="global-chat-overlay" id="globalChatOverlay" onclick="closeFloatingChat()"></div>

    <!-- Global AI Chat Window -->
    <div class="global-ai-chat-window" id="globalAiChatWindow">
        <div class="global-chat-header">
        <h3 id="globalChatTitle">AI ë„ìš°ë¯¸</h3>
        <button class="close-global-chat" onclick="closeFloatingChat()">Ã—</button>
    </div>
        <div class="global-chat-messages" id="globalChatMessages"></div>
        <div class="global-chat-input-area">
        <div class="chat-left-buttons">
            <button class="icon-button" id="saveGlobalChatBtn" onclick="saveGlobalConversation()" disabled title="ëŒ€í™” ë‚´ìš©ì„ PDVì— ì €ì¥">
                <img src="/jeju-integrated/images/save-icon.svg" alt="ì €ì¥" class="button-icon">
            </button>
            <input type="file" id="globalFileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx">
            <button class="icon-button" onclick="document.getElementById('globalFileInput').click()" title="íŒŒì¼ ì—…ë¡œë“œ">
                <img src="/jeju-integrated/images/upload-icon.svg" alt="ì—…ë¡œë“œ" class="button-icon">
            </button>
        </div>
        <textarea id="globalChatInput" class="global-chat-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" rows="1"></textarea>
        <button class="global-send-button" id="globalSendButton" onclick="sendGlobalMessage()">â¤</button>
    </div>
    </div>

    <style>
    /* Floating Help Button */
    .floating-help-btn {
        position: fixed;
        top: 120px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: rgba(33, 150, 243, 0.9);
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        cursor: pointer;
        z-index: 998;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .floating-help-btn:hover {
        background: rgba(33, 150, 243, 1);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.6);
    }

    .help-icon {
        font-size: 32px;
        font-weight: bold;
        color: white;
        line-height: 1;
    }

    /* Global Chat Overlay */
    .global-chat-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .global-chat-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Global AI Chat Window */
    .global-ai-chat-window {
        position: fixed;
        top: 120px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
    }

    .global-ai-chat-window.active {
        opacity: 1;
        visibility: visible;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 500px;
        height: 700px;
        border-radius: 16px;
    }

    .global-chat-header {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease 0.3s;
    }

    .global-ai-chat-window.active .global-chat-header {
        opacity: 1;
    }

    .global-chat-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .global-chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    

    

    

    

    .close-global-chat {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
        line-height: 1;
    }

    .close-global-chat:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .global-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        opacity: 0;
        transition: opacity 0.3s ease 0.3s;
    }

    .global-ai-chat-window.active .global-chat-messages {
        opacity: 1;
    }

    .global-chat-input-area {
        border-top: 1px solid #E5E7EB;
        padding: 16px;
        display: flex;
        gap: 8px;
        align-items: flex-end;
        opacity: 0;
        transition: opacity 0.3s ease 0.3s;
    }

    .chat-left-buttons {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .icon-button {
        width: 40px;
        height: 40px;
        border: none;
        background: #F3F4F6;
        color: #1F2937;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 20px;
    }

    .icon-button:hover:not(:disabled) {
        background: #E5E7EB;
        transform: scale(1.05);
    }

    .icon-button:disabled {
        background: #F9FAFB;
        color: #D1D5DB;
        cursor: not-allowed;
    }

    .button-icon {
        width: 22px;
        height: 22px;
        /* filter removed */
    }

    .icon-button:hover:not(:disabled) .button-icon {
        /* filter removed */
    }

    .icon-button:disabled .button-icon {
        opacity: 0.3;
    }

    .icon-button:active:not(:disabled) {
        transform: scale(0.95);
    }

    .global-ai-chat-window.active .global-chat-input-area {
        opacity: 1;
    }

    .chat-left-buttons {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .icon-button {
        width: 40px;
        height: 40px;
        border: none;
        background: #F3F4F6;
        color: #1F2937;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 20px;
    }

    .icon-button:hover:not(:disabled) {
        background: #E5E7EB;
        transform: scale(1.05);
    }

    .icon-button:disabled {
        background: #F9FAFB;
        color: #D1D5DB;
        cursor: not-allowed;
    }

    .button-icon {
        width: 22px;
        height: 22px;
        /* filter removed */
    }

    .icon-button:hover:not(:disabled) .button-icon {
        /* filter removed */
    }

    .icon-button:disabled .button-icon {
        opacity: 0.3;
    }

    .icon-button:active:not(:disabled) {
        transform: scale(0.95);
    }

    .global-chat-input {
        flex: 1;
        border: 1px solid #E5E7EB;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        resize: none;
        max-height: 120px;
        font-family: 'Noto Sans KR', sans-serif;
    }

    .global-chat-input:focus {
        outline: none;
        border-color: #2196F3;
    }

    .global-send-button {
        width: 40px;
        height: 40px;
        border: none;
        background: #2196F3;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 20px;
    }

    .global-send-button:hover {
        background: #1976D2;
    }

    .global-send-button:disabled {
        background: #E5E7EB;
        cursor: not-allowed;
    }

    

    

    

    .global-message {
        display: flex;
        gap: 8px;
        max-width: 85%;
        animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .global-message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .global-message.assistant {
        align-self: flex-start;
    }

    .global-message-bubble {
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .global-message.user .global-message-bubble {
        background: #2196F3;
        color: white;
    }

    .global-message.assistant .global-message-bubble {
        background: #F3F4F6;
        color: #1F2937;
    }

    .global-message-bubble a {
        color: #2196F3;
        text-decoration: underline;
        font-weight: 600;
    }

    .global-message.user .global-message-bubble a {
        color: #FFE57F;
    }

    .global-typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: #F3F4F6;
        border-radius: 18px;
        width: fit-content;
    }

    .global-typing-dot {
        width: 8px;
        height: 8px;
        background: #9CA3AF;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .global-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .global-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-8px);
        }
    }
    </style>

    <script>
    (function() {
        const API_URL = '/api/jeju-integrated/chat';
        let globalChatHistory = [];

        // íƒ­ë³„ ë§ì¶¤í˜• ì¸ì‚¬ë§
        const greetings = {
            'tab1': {
                title: 'ì •ë¶€ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì •ë¶€ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì œì£¼ë„ì²­, ì œì£¼ì‹œì²­, ì„œê·€í¬ì‹œì²­, êµìœ¡ì²­, ê²½ì°°ì²­, ì„¸ê´€ ë“±ì˜ í–‰ì • ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'
            },
            'tab2': {
                title: 'ì˜ë£Œ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ì œì£¼ëŒ€í•™êµë³‘ì› ì˜ë£Œ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì§„ë£Œê³¼, ì˜ë£Œì§„, ì˜ˆì•½, ê±´ê°•ê²€ì§„ ë“± ë³‘ì› ì´ìš©ì— ê´€í•œ ëª¨ë“  ê²ƒì„ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ì–´ë–¤ ì§„ë£Œê³¼ë¥¼ ì°¾ìœ¼ì‹œë‚˜ìš”?'
            },
            'tab3': {
                title: 'ë²•ë¥  ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ì œì£¼ì§€ë°©ë²•ì› ë²•ë¥  ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë¯¼ì‚¬, í˜•ì‚¬, ê°€ì‚¬, í–‰ì • ì‚¬ê±´ ë° ë“±ê¸°, ê³µì¦ ë“± ë²•ì› ì—…ë¬´ì— ëŒ€í•´ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?'
            },
            'tab4': {
                title: 'êµìœ¡ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! êµìœ¡ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì´ˆë“±í•™êµë¶€í„° ëŒ€í•™êµê¹Œì§€ ëª¨ë“  êµìœ¡ ê³¼ì •ì— ëŒ€í•´ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ì–´ë–¤ í•™ë…„ì´ë‚˜ ê³¼ëª©ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?'
            },
            'tab5': {
                title: 'ê¸ˆìœµ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ê¸ˆìœµ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì€í–‰, ë³´í—˜, ì¦ê¶Œ ë“± ëª¨ë“  ê¸ˆìœµ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ì— ëŒ€í•´ ìƒë‹´í•´ë“œë¦½ë‹ˆë‹¤. ì–´ë–¤ ê¸ˆìœµ ì„œë¹„ìŠ¤ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?'
            },
            'tab6': {
                title: 'êµí†µÂ·ë¬¼ë¥˜ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! êµí†µÂ·ë¬¼ë¥˜ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë²„ìŠ¤, íƒì‹œ, ê¸°ì°¨, í•­ê³µ, íƒë°°, í™”ë¬¼ ë“± ëª¨ë“  ì´ë™ê³¼ ë°°ì†¡ì— ê´€í•´ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'
            },
            'tab7': {
                title: 'ì‹œì¥ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ì‹œì¥ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì˜¨ë¼ì¸ ì‡¼í•‘, ìƒí’ˆ ê²€ìƒ‰, íŒë§¤ ë°©ë²• ë“± ëª¨ë“  ê±°ë˜ í™œë™ì„ ì§€ì›í•©ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'
            },
            'default': {
                title: 'ì œì£¼ í†µí•© í¬í„¸ ë„ìš°ë¯¸',
                message: 'ì•ˆë…•í•˜ì„¸ìš”! ì œì£¼íŠ¹ë³„ìì¹˜ë„ í†µí•© í¬í„¸ AI ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì •ë¶€, ì˜ë£Œ, ë²•ë¥ , êµìœ¡, ê¸ˆìœµ, êµí†µ, ì‹œì¥ ë“± ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'
            }
        };

        window.openFloatingChat = function() {
            const chatWindow = document.getElementById('globalAiChatWindow');
            const overlay = document.getElementById('globalChatOverlay');
            const floatingBtn = document.getElementById('floatingHelpBtn');
            const chatMessages = document.getElementById('globalChatMessages');
            const chatTitle = document.getElementById('globalChatTitle');

            if (!chatWindow || !overlay || !floatingBtn) return;

            // í˜„ì¬ í™œì„±í™”ëœ íƒ­ ê°ì§€
            const activeTab = document.querySelector('.tab-button.active');
            const currentTab = activeTab ? activeTab.getAttribute('data-tab') : 'default';

            // íƒ­ì— ë§ëŠ” ì¸ì‚¬ë§ ê°€ì ¸ì˜¤ê¸°
            const greeting = greetings[currentTab] || greetings['default'];

            // ì±„íŒ… ì´ˆê¸°í™”
            chatMessages.innerHTML = '';
            globalChatHistory = [];
            
            // ì œëª© ì„¤ì •
            chatTitle.textContent = greeting.title;

            // ì˜¤ë²„ë ˆì´ ë° ìƒë‹´ì°½ í™œì„±í™”
            overlay.classList.add('active');
            floatingBtn.style.opacity = '0';
            floatingBtn.style.visibility = 'hidden';

            setTimeout(function() {
                chatWindow.classList.add('active');
                // ì¸ì‚¬ë§ ì¶”ê°€
                setTimeout(function() {
                    addGlobalMessage(greeting.message, 'assistant');
                }, 300);
            }, 100);

            // ì…ë ¥ì°½ í¬ì»¤ìŠ¤
            setTimeout(function() {
                const input = document.getElementById('globalChatInput');
                if (input) input.focus();
            }, 800);
        };

        window.closeFloatingChat = function() {
            const chatWindow = document.getElementById('globalAiChatWindow');
            const overlay = document.getElementById('globalChatOverlay');
            const floatingBtn = document.getElementById('floatingHelpBtn');

            if (chatWindow) chatWindow.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            
            setTimeout(function() {
                if (floatingBtn) {
                    floatingBtn.style.opacity = '1';
                    floatingBtn.style.visibility = 'visible';
                }
            }, 300);
        };

        function addGlobalMessage(content, role) {
            const messagesContainer = document.getElementById('globalChatMessages');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'global-message ' + role;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'global-message-bubble';

            // ë§ˆí¬ë‹¤ìš´ ë§í¬ë¥¼ HTML ë§í¬ë¡œ ë³€í™˜
            const linkPattern = /\[([^\]]+)\]\(([^)]+)\)/g;
            const htmlContent = content.replace(linkPattern, '<a href="$2" target="_blank">$1</a>');

            bubbleDiv.innerHTML = htmlContent;
            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showGlobalTypingIndicator() {
            const messagesContainer = document.getElementById('globalChatMessages');
            if (!messagesContainer) return;

            const typingDiv = document.createElement('div');
            typingDiv.className = 'global-message assistant';
            typingDiv.id = 'globalTypingIndicator';

            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'global-typing-indicator';
            indicatorDiv.innerHTML = '<div class="global-typing-dot"></div><div class="global-typing-dot"></div><div class="global-typing-dot"></div>';

            typingDiv.appendChild(indicatorDiv);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeGlobalTypingIndicator() {
            const indicator = document.getElementById('globalTypingIndicator');
            if (indicator) indicator.remove();
        }

        window.sendGlobalMessage = async function() {
            const input = document.getElementById('globalChatInput');
            const sendButton = document.getElementById('globalSendButton');

            if (!input) return;

            const message = input.value.trim();
            if (!message) return;

            addGlobalMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            // í˜„ì¬ íƒ­ ì •ë³´ í¬í•¨
            const activeTab = document.querySelector('.tab-button.active');
            const currentTab = activeTab ? activeTab.getAttribute('data-tab') : 'default';
            const tabName = activeTab ? activeTab.textContent : 'ë©”ì¸';

            globalChatHistory.push({
                role: 'user',
                content: `[í˜„ì¬ í˜ì´ì§€: ${tabName}] ${message}`
            });

            if (sendButton) sendButton.disabled = true;
            showGlobalTypingIndicator();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: globalChatHistory,
                        category: 'í†µí•© ë„ìš°ë¯¸'
                    })
                });

                if (!response.ok) throw new Error('API ìš”ì²­ ì‹¤íŒ¨');

                const responseData = await response.json();

                globalChatHistory.push({
                    role: 'assistant',
                    content: responseData.message
                });
                console.log('ğŸ“ ëŒ€í™” ì¶”ê°€ë¨. ì´ ë©”ì‹œì§€:', globalChatHistory.length);

                removeGlobalTypingIndicator();
                addGlobalMessage(responseData.message, 'assistant');
                
                // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
                console.log('ğŸ” ë””ë²„ê¹…:', {
                    'globalChatHistory ì¡´ì¬': !!globalChatHistory,
                    'globalChatHistory ê¸¸ì´': globalChatHistory?.length,
                    'saveBtn ìš”ì†Œ': !!document.getElementById('saveGlobalChatBtn')
                });
                const saveBtn = document.getElementById('saveGlobalChatBtn');
                if (saveBtn && globalChatHistory && globalChatHistory.length > 0) {
                    console.log('âœ… ì¡°ê±´ í†µê³¼: ë²„íŠ¼ í™œì„±í™” ì‹œë„');
                    saveBtn.disabled = false;
                    console.log('âœ“ saveBtn.disabled =', saveBtn.disabled);
                    console.log('âœ“ ì €ì¥ ë²„íŠ¼ í™œì„±í™”ë¨');
                }

            } catch (error) {
                console.error('Error:', error);
                removeGlobalTypingIndicator();
                addGlobalMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'assistant');
            } finally {
                if (sendButton) sendButton.disabled = false;
            }
        };

        // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì • ë° Enter í‚¤ ì²˜ë¦¬
        setTimeout(function() {
            const textarea = document.getElementById('globalChatInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

                textarea.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.sendGlobalMessage();
                    }
                });
            }
        }, 100);
        // PDV ì €ì¥ í•¨ìˆ˜
        window.saveGlobalConversation = function() {
            if (!globalChatHistory || globalChatHistory.length === 0) {
                alert('ì €ì¥í•  ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const activeTab = document.querySelector('.tab-button.active');
            const currentTab = activeTab ? activeTab.getAttribute('data-tab') : 'default';
            const tabName = activeTab ? activeTab.textContent : 'ë©”ì¸';

            const userMessages = globalChatHistory.filter(m => m.role === 'user');
            const firstUserMsg = userMessages[0]?.content || '';
            
            const conversationData = {
                id: Date.now(),
                category: tabName,
                service: 'AI ë„ìš°ë¯¸',
                timestamp: new Date().toISOString(),
                who: 'ì‚¬ìš©ì',
                what: firstUserMsg.substring(0, 50) + (firstUserMsg.length > 50 ? '...' : ''),
                when: new Date().toLocaleString('ko-KR'),
                where: tabName + ' íƒ­',
                why: 'ì •ë³´ ë¬¸ì˜',
                how: 'AI ìƒë‹´',
                messages: [...globalChatHistory],
                summary: `ì´ ${globalChatHistory.length}ê°œì˜ ë©”ì‹œì§€. ${userMessages.length}ê°œì˜ ì§ˆë¬¸.`
            };

            if (typeof window.saveToPDV === 'function') {
                window.saveToPDV(conversationData);
                alert('âœ… ëŒ€í™”ê°€ PDVì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // ìë™ìœ¼ë¡œ ëŒ€í™”ì°½ ë‹«ê¸°
                setTimeout(function() {
                    closeFloatingChat();
                }, 500);
                
                const saveBtn = document.getElementById('saveGlobalChatBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span>âœ“</span><span>ì €ì¥ë¨</span>';
                }
            } else {
                alert('âŒ PDV ì €ì¥ ê¸°ëŠ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. PDV íƒ­ì„ ë¨¼ì € ì—´ì–´ì£¼ì„¸ìš”.');
            }
        };

        const originalOpenFloating = window.openFloatingChat;
        if (originalOpenFloating) {
            window.openFloatingChat = function() {
                originalOpenFloating.call(this);
                
                setTimeout(function() {
                    const saveBtn = document.getElementById('saveGlobalChatBtn');
                    if (saveBtn) {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<span>ğŸ’¾</span><span>ì €ì¥</span>';
                    }
                }, 100);
            };
        }

    })();
    
        // PDV ì €ì¥ í•¨ìˆ˜ (ì „ì—­)
        window.saveToPDV = function(conversationData) {
            const PDV_STORAGE_KEY = 'jeju_integrated_pdv';
            
            // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const stored = localStorage.getItem(PDV_STORAGE_KEY);
            const conversations = stored ? JSON.parse(stored) : [];
            
            // ìƒˆ ëŒ€í™” ì¶”ê°€
            conversations.push(conversationData);
            
            // ì €ì¥
            localStorage.setItem(PDV_STORAGE_KEY, JSON.stringify(conversations));
            
            console.log('âœ… PDV ì €ì¥ ì™„ë£Œ:', conversationData.id);
            
            return true;
        };

</script>
</body>
</html>
