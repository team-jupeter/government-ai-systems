from flask import Flask, request, jsonify
from flask_cors import CORS
import anthropic
import os
import logging

app = Flask(__name__)
CORS(app)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

ANTHROPIC_API_KEY = os.environ.get('ANTHROPIC_API_KEY', '')
client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY) if ANTHROPIC_API_KEY else None

SYSTEM_INFO = {
    "system_name": "ì œì£¼ë„ í†µí•© ì£¼ë¯¼ì„¼í„° ì‹œìŠ¤í…œ",
    "description": "ì›ìŠ¤í†± í–‰ì • ì„œë¹„ìŠ¤ í†µí•© í”Œë«í¼",
    "service_centers": 43,
    "integrated_services": 1250,
    "daily_visitors": 15000,
    "online_rate": "78.5%",
    "satisfaction": "94.8%"
}

SERVICE_CATEGORIES = [
    {"id": "resident", "name": "ì£¼ë¯¼ë“±ë¡", "icon": "ğŸªª", "services": 45},
    {"id": "family", "name": "ê°€ì¡±ê´€ê³„", "icon": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", "services": 38},
    {"id": "property", "name": "ë¶€ë™ì‚°", "icon": "ğŸ ", "services": 62},
    {"id": "vehicle", "name": "ìë™ì°¨", "icon": "ğŸš—", "services": 35},
    {"id": "tax", "name": "ì„¸ê¸ˆ", "icon": "ğŸ’°", "services": 48},
    {"id": "welfare", "name": "ë³µì§€", "icon": "â¤ï¸", "services": 125},
    {"id": "education", "name": "êµìœ¡", "icon": "ğŸ“š", "services": 42},
    {"id": "business", "name": "ì‚¬ì—…ì", "icon": "ğŸ’¼", "services": 55},
    {"id": "military", "name": "ë³‘ë¬´", "icon": "ğŸ–ï¸", "services": 28},
    {"id": "passport", "name": "ì—¬ê¶Œ", "icon": "ğŸ“˜", "services": 15}
]

POPULAR_SERVICES = [
    {"name": "ì£¼ë¯¼ë“±ë¡ë“±ë³¸ ë°œê¸‰", "time": "ì¦‰ì‹œ", "online": True, "visits": 3500},
    {"name": "ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ", "time": "ì¦‰ì‹œ", "online": True, "visits": 2800},
    {"name": "ì¸ê°ì¦ëª…ì„œ ë°œê¸‰", "time": "ì¦‰ì‹œ", "online": False, "visits": 1200},
    {"name": "ì „ì…ì‹ ê³ ", "time": "ì¦‰ì‹œ", "online": True, "visits": 980},
    {"name": "ìë™ì°¨ ë“±ë¡", "time": "30ë¶„", "online": True, "visits": 750},
    {"name": "ê¸°ì´ˆìƒí™œìˆ˜ê¸‰ ì‹ ì²­", "time": "14ì¼", "online": True, "visits": 620}
]

SCENARIOS = [
    {
        "icon": "ğŸ”—",
        "title": "ì›ìŠ¤í†± í†µí•© ì„œë¹„ìŠ¤",
        "problem": "ì´ì‚¬ ì‹œ ì£¼ì†Œë³€ê²½ì„ ìœ„í•´ 7ê°œ ê¸°ê´€ ê°œë³„ ë°©ë¬¸ í•„ìš”",
        "solution": "ì „ì…ì‹ ê³  í•œ ë²ˆìœ¼ë¡œ ëª¨ë“  ê¸°ê´€ ì£¼ì†Œ ìë™ ë³€ê²½",
        "savings": "ì²˜ë¦¬ ì‹œê°„ 95% ë‹¨ì¶•"
    },
    {
        "icon": "ğŸ“±",
        "title": "ëª¨ë°”ì¼ ì£¼ë¯¼ì„¼í„°",
        "problem": "ë°©ë¬¸ ë¯¼ì›ì„ ìœ„í•´ í‰ê·  ì™•ë³µ 2ì‹œê°„ ì†Œìš”",
        "solution": "78.5% ë¯¼ì›ì„ ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ 24ì‹œê°„ ì²˜ë¦¬",
        "savings": "ì—°ê°„ 450ë§Œ ì‹œê°„ ì ˆì•½"
    },
    {
        "icon": "ğŸ¤–",
        "title": "AI ë¯¼ì› ë„ìš°ë¯¸",
        "problem": "ë³µì¡í•œ í–‰ì • ì ˆì°¨, í•„ìš” ì„œë¥˜ íŒŒì•… ì–´ë ¤ì›€",
        "solution": "AIê°€ ìƒí™© ë¶„ì„í•˜ì—¬ í•„ìš” ì„œë¹„ìŠ¤, ì„œë¥˜ ìë™ ì•ˆë‚´",
        "savings": "ë¯¼ì› ì²˜ë¦¬ ì˜¤ë¥˜ 87% ê°ì†Œ"
    },
    {
        "icon": "ğŸ””",
        "title": "ë§ì¶¤í˜• ì•Œë¦¼ ì„œë¹„ìŠ¤",
        "problem": "ìˆ˜ê¸‰ ìê²©ì´ ìˆì–´ë„ ëª°ë¼ì„œ ì‹ ì²­ ëª»í•˜ëŠ” ê²½ìš° ë‹¤ìˆ˜",
        "solution": "AIê°€ ì£¼ë¯¼ ë°ì´í„° ë¶„ì„, í˜œíƒ ëŒ€ìƒìì—ê²Œ ìë™ ì•Œë¦¼",
        "savings": "ë³µì§€ ì‚¬ê°ì§€ëŒ€ 92% í•´ì†Œ"
    }
]

AGENTS = [
    {"id": "service_guide", "name": "ğŸ“‹ ì„œë¹„ìŠ¤ ì•ˆë‚´ Agent"},
    {"id": "document_helper", "name": "ğŸ“„ ì„œë¥˜ ì¤€ë¹„ Agent"},
    {"id": "welfare_finder", "name": "â¤ï¸ ë³µì§€ í˜œíƒ Agent"},
    {"id": "location_guide", "name": "ğŸ“ ìœ„ì¹˜ ì•ˆë‚´ Agent"},
    {"id": "complaint_handler", "name": "ğŸ“ ë¯¼ì› ì²˜ë¦¬ Agent"}
]

@app.route('/api/jeju-integrated/info', methods=['GET'])
def get_info():
    return jsonify(SYSTEM_INFO)

@app.route('/api/jeju-integrated/categories', methods=['GET'])
def get_categories():
    return jsonify({"categories": SERVICE_CATEGORIES})

@app.route('/api/jeju-integrated/popular-services', methods=['GET'])
def get_popular_services():
    return jsonify({"services": POPULAR_SERVICES})

@app.route('/api/jeju-integrated/scenarios', methods=['GET'])
def get_scenarios():
    return jsonify({"scenarios": SCENARIOS})

@app.route('/api/jeju-integrated/agents', methods=['GET'])
def get_agents():
    return jsonify({"agents": AGENTS})

@app.route('/api/jeju-integrated/consultation', methods=['POST', 'OPTIONS'])
def consultation():
    if request.method == 'OPTIONS':
        return '', 204
    
    if not client:
        return jsonify({"response": "âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 200
    
    try:
        data = request.json
        message = data.get('message', '')
        agent_type = data.get('agent_type', 'service_guide')
        
        prompts = {
            "service_guide": "ë‹¹ì‹ ì€ ì œì£¼ë„ í†µí•© ì£¼ë¯¼ì„¼í„° ì„œë¹„ìŠ¤ ì•ˆë‚´ AIì…ë‹ˆë‹¤. 1,250ê°œ í–‰ì • ì„œë¹„ìŠ¤ì˜ ì‹ ì²­ ë°©ë²•, ì²˜ë¦¬ ê¸°ê°„, ìˆ˜ìˆ˜ë£Œë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "document_helper": "ë‹¹ì‹ ì€ ì„œë¥˜ ì¤€ë¹„ ë„ìš°ë¯¸ AIì…ë‹ˆë‹¤. ê° ë¯¼ì›ì— í•„ìš”í•œ êµ¬ë¹„ ì„œë¥˜ì™€ ë°œê¸‰ ë°©ë²•ì„ ìƒì„¸íˆ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "welfare_finder": "ë‹¹ì‹ ì€ ë³µì§€ í˜œíƒ ì°¾ê¸° AIì…ë‹ˆë‹¤. ì£¼ë¯¼ì˜ ìƒí™©ì— ë§ëŠ” ë³µì§€ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì•„ ì‹ ì²­ ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "location_guide": "ë‹¹ì‹ ì€ ìœ„ì¹˜ ì•ˆë‚´ AIì…ë‹ˆë‹¤. ê°€ì¥ ê°€ê¹Œìš´ ì£¼ë¯¼ì„¼í„°ì™€ ë°©ë¬¸ ì‹œ í•„ìš”í•œ ì •ë³´ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.",
            "complaint_handler": "ë‹¹ì‹ ì€ ë¯¼ì› ì²˜ë¦¬ AIì…ë‹ˆë‹¤. ë¯¼ì› ì ‘ìˆ˜, ì²˜ë¦¬ í˜„í™© ì¡°íšŒ, ì´ì˜ ì‹ ì²­ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤."
        }
        
        system_prompt = prompts.get(agent_type, prompts["service_guide"])
        system_prompt += "\n\nì œì£¼ë„ë¯¼ì˜ í–‰ì • í¸ì˜ë¥¼ ìœ„í•´ ì¹œì ˆí•˜ê³  ì •í™•í•˜ê²Œ ì•ˆë‚´í•˜ì„¸ìš”. ì˜¨ë¼ì¸ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ëŠ” ìš°ì„  ì•ˆë‚´í•˜ì„¸ìš”."
        
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1500,
            system=system_prompt,
            messages=[{"role": "user", "content": message}]
        )
        
        return jsonify({"response": response.content[0].text})
        
    except Exception as e:
        return jsonify({"response": f"ì˜¤ë¥˜: {str(e)}"}), 500

@app.route('/api/jeju-integrated/find-service', methods=['POST'])
def find_service():
    data = request.json
    keyword = data.get('keyword', '')
    
    results = [
        {"name": "ì£¼ë¯¼ë“±ë¡ë“±ë³¸ ë°œê¸‰", "category": "ì£¼ë¯¼ë“±ë¡", "online": True, "time": "ì¦‰ì‹œ"},
        {"name": "ì£¼ë¯¼ë“±ë¡ì´ˆë³¸ ë°œê¸‰", "category": "ì£¼ë¯¼ë“±ë¡", "online": True, "time": "ì¦‰ì‹œ"},
        {"name": "ì£¼ë¯¼ë“±ë¡ì¦ ì¬ë°œê¸‰", "category": "ì£¼ë¯¼ë“±ë¡", "online": False, "time": "7ì¼"}
    ]
    
    return jsonify({
        "keyword": keyword,
        "results": results,
        "total": len(results)
    })

@app.route('/api/jeju-integrated/check-welfare', methods=['POST'])
def check_welfare():
    data = request.json
    
    eligible_benefits = [
        {"name": "ê¸°ì´ˆì—°ê¸ˆ", "amount": "ì›” 32ë§Œì›", "eligible": True},
        {"name": "ì£¼ê±°ê¸‰ì—¬", "amount": "ì›” 15ë§Œì›", "eligible": True},
        {"name": "ì—ë„ˆì§€ë°”ìš°ì²˜", "amount": "ì—° 18ë§Œì›", "eligible": True},
        {"name": "í†µì‹ ë¹„ ê°ë©´", "amount": "ì›” 2.6ë§Œì›", "eligible": False}
    ]
    
    return jsonify({
        "analysis_id": "WF-2025-112400001",
        "eligible_benefits": eligible_benefits,
        "total_monthly": "49ë§Œì›",
        "apply_link": "https://bokjiro.go.kr"
    })

if __name__ == '__main__':
    logger.info("ğŸš€ ì œì£¼ë„ í†µí•© ì£¼ë¯¼ì„¼í„° ì‹œìŠ¤í…œ ë°±ì—”ë“œ ì‹œì‘ (í¬íŠ¸ 5008)")
    app.run(host='0.0.0.0', port=5008, debug=False)
