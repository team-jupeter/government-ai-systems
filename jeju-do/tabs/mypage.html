<style>
    .mypage-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .pdv-info-section {
        background: linear-gradient(135deg, #003d82 0%, #0052a8 100%);
        color: white;
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 40px;
        box-shadow: 0 4px 12px rgba(0,61,130,0.2);
    }

    .pdv-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .pdv-info-title {
        font-size: 1.5em;
        font-weight: 700;
    }

    .pdv-info-badge {
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
    }

    .pdv-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .pdv-info-item {
        background: rgba(255,255,255,0.1);
        padding: 16px;
        border-radius: 6px;
    }

    .pdv-info-label {
        font-size: 0.85em;
        opacity: 0.8;
        margin-bottom: 6px;
    }

    .pdv-info-value {
        font-size: 1.1em;
        font-weight: 600;
    }

    .documents-section {
        background: white;
        border: 1px solid #d5d5d5;
        border-radius: 8px;
        padding: 32px;
        margin-bottom: 40px;
    }

    .documents-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e0e0e0;
    }

    .documents-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
    }

    .documents-subtitle {
        color: #666;
        font-size: 0.95em;
    }

    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
    }

    .document-btn {
        background: linear-gradient(135deg, #f5f8fb 0%, #ffffff 100%);
        border: 2px solid #d5d5d5;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    .document-btn:hover {
        border-color: #003d82;
        background: linear-gradient(135deg, #ffffff 0%, #f5f8fb 100%);
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,61,130,0.15);
    }

    .document-icon {
        font-size: 2.5em;
    }

    .document-name {
        font-weight: 600;
        color: #333;
        font-size: 0.95em;
    }

    .document-status {
        font-size: 0.8em;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
    }

    .status-available {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-missing {
        background: #ffebee;
        color: #c62828;
    }

    .activities-section {
        background: white;
        border: 1px solid #d5d5d5;
        border-radius: 8px;
        padding: 32px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #1a1a1a;
    }

    .search-box {
        padding: 8px 16px;
        border: 1px solid #d5d5d5;
        border-radius: 4px;
        width: 300px;
    }

    .timeline {
        position: relative;
        padding-left: 40px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 16px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e0e0e0;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 32px;
        background: #f9f9f9;
        border-radius: 6px;
        padding: 20px;
        border-left: 3px solid #003d82;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -27px;
        top: 24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #003d82;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #e0e0e0;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .timeline-type {
        display: inline-block;
        padding: 4px 12px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .timeline-date {
        font-size: 0.9em;
        color: #666;
    }

    .timeline-content {
        color: #333;
        margin-bottom: 8px;
    }

    .timeline-metadata {
        font-size: 0.85em;
        color: #666;
    }

    .btn-create-hash {
        background: #2e7d32;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        margin-top: 24px;
    }

    .btn-create-hash:hover {
        background: #1b5e20;
        box-shadow: 0 4px 12px rgba(46,125,50,0.3);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 16px;
    }
</style>

<div class="mypage-container">
    <!-- PDV ì •ë³´ ì„¹ì…˜ -->
    <div id="pdv-info-section" class="pdv-info-section"></div>

    <!-- í•„ìš” ì„œë¥˜ ì„¹ì…˜ -->
    <div id="documents-section" class="documents-section"></div>

    <!-- í™œë™ íƒ€ì„ë¼ì¸ ì„¹ì…˜ -->
    <div class="activities-section">
        <div class="section-header">
            <h2 class="section-title">ğŸ“‹ PDV í™œë™ íƒ€ì„ë¼ì¸</h2>
            <input type="text" id="activity-search" class="search-box" placeholder="í™œë™ ê²€ìƒ‰...">
        </div>
        
        <div id="timeline-container" class="timeline"></div>
        
        <div id="create-hash-btn-container"></div>
    </div>
</div>

<script>
// My Page ì´ˆê¸°í™”
function initMyPage() {
    const user = window.authManager?.getCurrentUser();
    
    if (!user) {
        showEmptyMyPage();
        return;
    }
    
    displayPDVInfo(user);
    displayDocuments(user);
    loadActivities(user);
}

// PDV ì •ë³´ í‘œì‹œ
function displayPDVInfo(user) {
    const container = document.getElementById('pdv-info-section');
    
    let typeInfo = '';
    let detailsHTML = '';
    
    if (user.type === 'citizen') {
        typeInfo = 'ğŸ™‹ ê°œì¸';
        detailsHTML = `
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì´ë¦„</div>
                <div class="pdv-info-value">${user.personData?.name || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì£¼ì†Œ</div>
                <div class="pdv-info-value">${user.personData?.address || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì „í™”ë²ˆí˜¸</div>
                <div class="pdv-info-value">${user.phoneNumber}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì´ë©”ì¼</div>
                <div class="pdv-info-value">${user.personData?.email || 'ë¯¸ë“±ë¡'}</div>
            </div>
        `;
    } else {
        typeInfo = 'ğŸ¢ ' + (user.orgData?.orgType || 'ë‹¨ì²´');
        detailsHTML = `
            <div class="pdv-info-item">
                <div class="pdv-info-label">ë‹¨ì²´ëª…</div>
                <div class="pdv-info-value">${user.orgData?.name || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ë‹¨ì²´ ì¢…ë¥˜</div>
                <div class="pdv-info-value">${user.orgData?.orgType || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì£¼ì†Œ</div>
                <div class="pdv-info-value">${user.orgData?.address || '-'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì „í™”ë²ˆí˜¸</div>
                <div class="pdv-info-value">${user.phoneNumber}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì´ë©”ì¼</div>
                <div class="pdv-info-value">${user.orgData?.email || 'ë¯¸ë“±ë¡'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ëŒ€í‘œì</div>
                <div class="pdv-info-value">${user.orgData?.ceo || 'ë¯¸ë“±ë¡'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div>
                <div class="pdv-info-value">${user.orgData?.businessNumber || 'ë¯¸ë“±ë¡'}</div>
            </div>
            <div class="pdv-info-item">
                <div class="pdv-info-label">ë²•ì¸ë“±ë¡ë²ˆí˜¸</div>
                <div class="pdv-info-value">${user.orgData?.corporateNumber || 'ë¯¸ë“±ë¡'}</div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="pdv-info-header">
            <div class="pdv-info-title">Private Data Vault</div>
            <div class="pdv-info-badge">${typeInfo}</div>
        </div>
        <div class="pdv-info-item">
            <div class="pdv-info-label">PDV ID</div>
            <div class="pdv-info-value">${user.pdvId}</div>
        </div>
        <div class="pdv-info-item">
            <div class="pdv-info-label">ìƒì„±ì¼</div>
            <div class="pdv-info-value">${new Date(user.createdAt).toLocaleDateString('ko-KR')}</div>
        </div>
        <div class="pdv-info-grid">
            ${detailsHTML}
        </div>
    `;
}

// í•„ìš” ì„œë¥˜ í‘œì‹œ
function displayDocuments(user) {
    const container = document.getElementById('documents-section');
    
    let documents = [];
    let title = '';
    
    if (user.type === 'citizen') {
        documents = [
            { name: 'ì£¼ë¯¼ë“±ë¡ì¦', icon: 'ğŸªª', viewable: true },
            { name: 'ì£¼ë¯¼ë“±ë¡í‘œ ë“±ë³¸', icon: 'ğŸ“„', viewable: true },
            { name: 'ì£¼ë¯¼ë“±ë¡í‘œ ì´ˆë³¸', icon: 'ğŸ“„', viewable: true },
            { name: 'ì¸ê°ì¦ëª…ì„œ', icon: 'ğŸ”', viewable: true },
            { name: 'ë³¸ì¸ì„œëª…ì‚¬ì‹¤í™•ì¸ì„œ', icon: 'âœï¸', viewable: true },
            { name: 'ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', viewable: true },
            { name: 'ê±´ê°•ë³´í—˜ìê²©ë“ì‹¤í™•ì¸ì„œ', icon: 'ğŸ¥', viewable: true },
            { name: 'ì†Œë“ê¸ˆì•¡ì¦ëª…ì›', icon: 'ğŸ’°', viewable: true },
            { name: 'ì¬ì‚°ì„¸ë‚©ì„¸ì¦ëª…ì„œ', icon: 'ğŸ ', viewable: true }
        ];
        title = 'ê°œì¸ í•„ìš” ì„œë¥˜';
    } else {
        const orgType = user.orgData?.orgType;
        
        // ì£¼ì‹íšŒì‚¬ ê¸°ë³¸ ì„œë¥˜
        documents = [
            { name: 'ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸', icon: 'ğŸ“‹', viewable: true },
            { name: 'ì‚¬ì—…ìë“±ë¡ì¦', icon: 'ğŸ¢', viewable: true },
            { name: 'ì •ê´€', icon: 'ğŸ“œ', viewable: true },
            { name: 'ì£¼ì£¼ëª…ë¶€', icon: 'ğŸ“Š', viewable: true },
            { name: 'ë²•ì¸ì¸ê°ì¦ëª…ì„œ', icon: 'ğŸ”', viewable: true },
            { name: 'ì¬ë¬´ì œí‘œ', icon: 'ğŸ’¼', viewable: true },
            { name: 'ì†ìµê³„ì‚°ì„œ', icon: 'ğŸ“ˆ', viewable: true },
            { name: 'ì¬ë¬´ìƒíƒœí‘œ', icon: 'ğŸ“‰', viewable: true },
            { name: 'ë²•ì¸ì„¸ì‹ ê³ ì„œ', icon: 'ğŸ“', viewable: true },
            { name: 'ì„ëŒ€ì°¨ê³„ì•½ì„œ', icon: 'ğŸ¢', viewable: true }
        ];
        
        title = `${orgType} í•„ìš” ì„œë¥˜`;
    }
    
    const userDocuments = user.documents || [];
    
    let documentsHTML = documents.map(doc => {
        const hasDocument = userDocuments.some(d => d.name === doc.name);
        const statusClass = hasDocument ? 'status-available' : 'status-missing';
        const statusText = hasDocument ? 'ë³´ìœ ' : 'ë¯¸ë³´ìœ ';
        
        return `
            <button class="document-btn" onclick="handleDocumentClick('${doc.name}', ${hasDocument})">
                <div class="document-icon">${doc.icon}</div>
                <div class="document-name">${doc.name}</div>
                <span class="document-status ${statusClass}">${statusText}</span>
            </button>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="documents-header">
            <h2 class="documents-title">ğŸ“„ ${title}</h2>
            <p class="documents-subtitle">
                âš ï¸ ì´ ì„œë¥˜ë“¤ì€ ë³¸ì¸ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íƒ€ì¸ì—ê²Œ ê³µìœ í•˜ê±°ë‚˜ ì „ì†¡í•˜ë ¤ë©´ ë³„ë„ì˜ ê¶Œí•œ ë¶€ì—¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
        </div>
        <div class="documents-grid">
            ${documentsHTML}
        </div>
    `;
}

// ì„œë¥˜ í´ë¦­ í•¸ë“¤ëŸ¬
function handleDocumentClick(docName, hasDocument) {
    if (hasDocument) {
        alert(`"${docName}" ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`);
    } else {
        alert(`"${docName}" ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`);
    }
}

// í™œë™ ë¡œë“œ (ì´ì „ê³¼ ë™ì¼)
function loadActivities(user) {
    const activities = user.activities || [];
    const container = document.getElementById('timeline-container');
    
    if (activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p style="font-size: 1.1em; margin-bottom: 8px;">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>
                <p style="color: #999;">AI ìƒë‹´, ë¬¸ì„œ ì „ì†¡ ë“±ì˜ í™œë™ì´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤</p>
            </div>
        `;
        document.getElementById('create-hash-btn-container').innerHTML = '';
        return;
    }
    
    const sortedActivities = activities.sort((a, b) => 
        new Date(a.timestamp) - new Date(b.timestamp)
    );
    
    sortedActivities.forEach((activity, index) => {
        activity.serialNumber = index + 1;
    });
    
    let html = sortedActivities.map(activity => `
        <div class="timeline-item">
            <div class="timeline-header">
                <span class="timeline-type">#${activity.serialNumber} - ${activity.type}</span>
                <span class="timeline-date">${new Date(activity.timestamp).toLocaleString('ko-KR')}</span>
            </div>
            <div class="timeline-content">${activity.content}</div>
            ${activity.counterparty ? `<div class="timeline-metadata">ìƒëŒ€ë°©: ${activity.counterparty}</div>` : ''}
            ${activity.location ? `<div class="timeline-metadata">ì¥ì†Œ: ${activity.location}</div>` : ''}
        </div>
    `).join('');
    
    container.innerHTML = html;
    
    if (activities.length >= 5) {
        document.getElementById('create-hash-btn-container').innerHTML = `
            <button class="btn-create-hash" onclick="createOpenHashGroups()">
                ğŸ”— OpenHash ìƒì„± (${activities.length}ê°œ í™œë™)
            </button>
        `;
    }
}

// OpenHash ìƒì„±
async function createOpenHashGroups() {
    const user = window.authManager?.getCurrentUser();
    if (!user || !user.activities) return;
    
    const activities = user.activities;
    
    if (activities.length < 5) {
        alert('OpenHashë¥¼ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 5ê°œì˜ í™œë™ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        const groups = await window.openHashManager.createHashGroups(activities);
        
        groups.forEach(group => {
            window.openHashManager.saveHashRecord(group, user.pdvId);
        });
        
        alert(`âœ… ${groups.length}ê°œì˜ OpenHash ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        
        if (confirm('OpenHash íƒ­ì—ì„œ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if (typeof switchTab === 'function') {
                switchTab('openhash');
            }
        }
        
        document.getElementById('create-hash-btn-container').innerHTML = `
            <button class="btn-create-hash" disabled style="opacity: 0.5; cursor: not-allowed;">
                âœ“ OpenHash ìƒì„±ë¨
            </button>
        `;
    } catch (error) {
        console.error('OpenHash ìƒì„± ì˜¤ë¥˜:', error);
        alert('OpenHash ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë¹ˆ My Page í‘œì‹œ
function showEmptyMyPage() {
    document.querySelector('.mypage-container').innerHTML = `
        <div class="empty-state" style="padding: 100px 20px;">
            <div class="empty-state-icon">ğŸ”</div>
            <h2 style="margin-bottom: 12px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p style="color: #666; margin-bottom: 24px;">Private Data Vaultì— ì ‘ê·¼í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <button onclick="openLoginModal()" style="padding: 12px 32px; background: #003d82; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1em;">
                ë¡œê·¸ì¸í•˜ê¸°
            </button>
        </div>
    `;
}

// ê²€ìƒ‰ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('activity-search');
    if (searchBox) {
        searchBox.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const items = document.querySelectorAll('.timeline-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
});

if (typeof window.initMyPage === 'undefined') {
    window.initMyPage = initMyPage;
}
</script>
