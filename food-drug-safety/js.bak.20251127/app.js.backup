const { useState, useEffect } = React;

// API ê²½ë¡œ ì„¤ì •
const API_BASE_URL = '/api/fooddrug';

function App() {
    const [selectedAgent, setSelectedAgent] = useState('general');
    const [agentTypes, setAgentTypes] = useState({});
    const [message, setMessage] = useState('');
    const [chatHistory, setChatHistory] = useState([]);
    const [loading, setLoading] = useState(false);
    const [documentHash, setDocumentHash] = useState('');
    const [verifyResult, setVerifyResult] = useState(null);
    const [activeTab, setActiveTab] = useState('consultation');

    // Agent íƒ€ì… ëª©ë¡ ë¡œë“œ
    useEffect(() => {
        fetch(`${API_BASE_URL}/agent-types`)
            .then(res => res.json())
            .then(data => setAgentTypes(data.agents))
            .catch(err => console.error('Agent íƒ€ì… ë¡œë“œ ì‹¤íŒ¨:', err));
    }, []);

    // ìƒë‹´ ìš”ì²­
    const handleConsultation = async () => {
        if (!message.trim()) return;

        const userMessage = message;
        setMessage('');
        setLoading(true);

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        setChatHistory(prev => [...prev, {
            role: 'user',
            content: userMessage,
            timestamp: new Date().toLocaleTimeString('ko-KR')
        }]);

        try {
            const response = await fetch(`${API_BASE_URL}/consultation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: userMessage,
                    agentType: selectedAgent
                })
            });

            const data = await response.json();

            if (response.ok) {
                setChatHistory(prev => [...prev, {
                    role: 'assistant',
                    content: data.response,
                    agentType: data.agentType,
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                }]);
            } else {
                setChatHistory(prev => [...prev, {
                    role: 'error',
                    content: data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
                    timestamp: new Date().toLocaleTimeString('ko-KR')
                }]);
            }
        } catch (error) {
            setChatHistory(prev => [...prev, {
                role: 'error',
                content: 'ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                timestamp: new Date().toLocaleTimeString('ko-KR')
            }]);
        } finally {
            setLoading(false);
        }
    };

    // ë¬¸ì„œ ê²€ì¦
    const handleVerify = async () => {
        if (!documentHash.trim()) return;

        setLoading(true);
        setVerifyResult(null);

        try {
            const response = await fetch(`${API_BASE_URL}/document-verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ documentHash })
            });

            const data = await response.json();
            setVerifyResult(data);
        } catch (error) {
            setVerifyResult({ error: 'ê²€ì¦ ì‹¤íŒ¨' });
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen py-8 px-4">
            <div className="max-w-7xl mx-auto">
                {/* í—¤ë” */}
                <div className="text-center mb-8 fade-in">
                    <h1 className="text-4xl font-bold text-indigo-900 mb-2">
                        ğŸ¥ ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ AI ìë™í™” ì‹œìŠ¤í…œ
                    </h1>
                    <p className="text-gray-600">
                        OpenHash ê¸°ë°˜ AI Agentë¥¼ í™œìš©í•œ ì—…ë¬´ ìë™í™” í”Œë«í¼
                    </p>
                </div>

                {/* íƒ­ ë©”ë‰´ */}
                <div className="flex justify-center mb-6 space-x-4">
                    <button
                        onClick={() => setActiveTab('consultation')}
                        className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                            activeTab === 'consultation'
                                ? 'bg-indigo-600 text-white shadow-lg'
                                : 'bg-white text-gray-700 hover:bg-gray-100'
                        }`}
                    >
                        ğŸ’¬ AI ìƒë‹´
                    </button>
                    <button
                        onClick={() => setActiveTab('verify')}
                        className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                            activeTab === 'verify'
                                ? 'bg-indigo-600 text-white shadow-lg'
                                : 'bg-white text-gray-700 hover:bg-gray-100'
                        }`}
                    >
                        ğŸ” ë¬¸ì„œ ê²€ì¦
                    </button>
                </div>

                {/* AI ìƒë‹´ íƒ­ */}
                {activeTab === 'consultation' && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Agent ì„ íƒ íŒ¨ë„ */}
                        <div className="bg-white rounded-xl shadow-lg p-6 fade-in">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                ğŸ¤– AI Agent ì„ íƒ
                            </h2>
                            <div className="space-y-2">
                                {Object.entries(agentTypes).map(([key, name]) => (
                                    <button
                                        key={key}
                                        onClick={() => setSelectedAgent(key)}
                                        className={`w-full text-left px-4 py-3 rounded-lg transition-all ${
                                            selectedAgent === key
                                                ? 'bg-indigo-100 border-2 border-indigo-500 text-indigo-900 font-semibold'
                                                : 'bg-gray-50 hover:bg-gray-100 text-gray-700'
                                        }`}
                                    >
                                        {name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* ì±„íŒ… íŒ¨ë„ */}
                        <div className="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 fade-in">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">
                                ğŸ’¬ ìƒë‹´ ì±„íŒ…
                            </h2>

                            {/* ì±„íŒ… íˆìŠ¤í† ë¦¬ */}
                            <div className="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg space-y-4">
                                {chatHistory.length === 0 && (
                                    <div className="text-center text-gray-500 py-8">
                                        ì„ íƒí•œ Agentì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”
                                    </div>
                                )}
                                {chatHistory.map((msg, idx) => (
                                    <div
                                        key={idx}
                                        className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-2xl rounded-lg p-4 ${
                                                msg.role === 'user'
                                                    ? 'bg-indigo-600 text-white'
                                                    : msg.role === 'error'
                                                    ? 'bg-red-100 text-red-800'
                                                    : 'bg-white border-2 border-gray-200 text-gray-800'
                                            }`}
                                        >
                                            <div className="text-sm font-semibold mb-1 opacity-75">
                                                {msg.role === 'user' ? 'ì‚¬ìš©ì' : 
                                                 msg.role === 'error' ? 'ì˜¤ë¥˜' : 
                                                 agentTypes[msg.agentType] || 'AI Agent'}
                                            </div>
                                            <div className="whitespace-pre-wrap">{msg.content}</div>
                                            <div className="text-xs mt-1 opacity-60">{msg.timestamp}</div>
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                            <div className="flex space-x-2">
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce"></div>
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* ì…ë ¥ ì˜ì—­ */}
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleConsultation()}
                                    placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                    className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                    disabled={loading}
                                />
                                <button
                                    onClick={handleConsultation}
                                    disabled={loading || !message.trim()}
                                    className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                >
                                    ì „ì†¡
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* ë¬¸ì„œ ê²€ì¦ íƒ­ */}
                {activeTab === 'verify' && (
                    <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8 fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                            ğŸ” OpenHash ë¬¸ì„œ ê²€ì¦
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    ë¬¸ì„œ í•´ì‹œ (SHA-256)
                                </label>
                                <input
                                    type="text"
                                    value={documentHash}
                                    onChange={(e) => setDocumentHash(e.target.value)}
                                    placeholder="ì˜ˆ: a7ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a"
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 font-mono text-sm"
                                />
                            </div>

                            <button
                                onClick={handleVerify}
                                disabled={loading || !documentHash.trim()}
                                className="w-full px-6 py-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                            >
                                {loading ? 'ê²€ì¦ ì¤‘...' : 'ë¬¸ì„œ ê²€ì¦'}
                            </button>

                            {/* ê²€ì¦ ê²°ê³¼ */}
                            {verifyResult && (
                                <div className={`mt-6 p-6 rounded-lg ${
                                    verifyResult.error
                                        ? 'bg-red-50 border-2 border-red-300'
                                        : 'bg-green-50 border-2 border-green-300'
                                }`}>
                                    {verifyResult.error ? (
                                        <div className="text-red-800">
                                            <div className="font-bold text-lg mb-2">âŒ ê²€ì¦ ì‹¤íŒ¨</div>
                                            <p>{verifyResult.error}</p>
                                        </div>
                                    ) : (
                                        <div className="text-green-800">
                                            <div className="font-bold text-xl mb-4">âœ… {verifyResult.message}</div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <div className="text-sm font-semibold">ì‹ ë¢°ë„ ì ìˆ˜</div>
                                                    <div className="text-2xl font-bold">{verifyResult.trustScore}%</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm font-semibold">ì €ì¥ ê³„ì¸µ</div>
                                                    <div className="text-2xl font-bold">Layer {verifyResult.layer}</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm font-semibold">ê²€ì¦ ë…¸ë“œ ìˆ˜</div>
                                                    <div className="text-2xl font-bold">{verifyResult.nodes}ê°œ</div>
                                                </div>
                                                <div>
                                                    <div className="text-sm font-semibold">ë“±ë¡ ì‹œê°„</div>
                                                    <div className="text-sm font-mono">{verifyResult.timestamp}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* ì„¤ëª… */}
                            <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-bold text-blue-900 mb-2">ğŸ’¡ OpenHash ê²€ì¦ ì •ë³´</h3>
                                <ul className="text-sm text-blue-800 space-y-1">
                                    <li>â€¢ ë¬¸ì„œ ì›ë³¸ì€ ì œì¶œ ê¸°ê´€ì— ì•”í˜¸í™” ì €ì¥ë©ë‹ˆë‹¤</li>
                                    <li>â€¢ ì˜¤í”ˆí•´ì‹œ ë„¤íŠ¸ì›Œí¬ì—ëŠ” 32ë°”ì´íŠ¸ í•´ì‹œë§Œ ë“±ë¡ë©ë‹ˆë‹¤</li>
                                    <li>â€¢ 4ê³„ì¸µ êµ¬ì¡°ë¡œ ì¤‘ìš”ë„ì— ë”°ë¼ ì°¨ë“± ë³´ì•ˆì„ ì œê³µí•©ë‹ˆë‹¤</li>
                                    <li>â€¢ í‰ê·  0.18ì´ˆ ë‚´ ì‹¤ì‹œê°„ ê²€ì¦ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

// ì•± ë Œë”ë§
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
